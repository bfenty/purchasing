{{define "toast"}}
<script>
//Show messages to the user
function showToast(message, type) {
    var toastTypeClass = '';
    switch (type) {
        case 'error': toastTypeClass = 'bg-danger'; break;
        case 'warning': toastTypeClass = 'bg-warning text-dark'; break;
        case 'info': toastTypeClass = 'bg-success'; break;
        default: toastTypeClass = 'bg-secondary';
    }

    var toastId = 'toast' + Date.now(); // Unique ID for each toast
    var toastHtml = `
        <div class="toast ${toastTypeClass}" id="${toastId}" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="5000">
            <div class="toast-body">
                ${message}
            </div>
        </div>`;

    $('#toastContainer').append(toastHtml);
    var toast = new bootstrap.Toast($('#' + toastId));
    toast.show();
    }
</script>
{{end}}

{{define "fetchmanufacturers"}}
<script>
    function fetchManufacturers() {
        return new Promise((resolve, reject) => {
              $.ajax({
                  url: '/api-handler?targetAPI=/api/manufacturers',
                  type: 'GET',
                  dataType: 'json',
                  success: function(data) {
                      console.log("Manufacturers fetched successfully. Data:", data);
                      manufacturers = data;
                      resolve(data);
                  },
                  error: function(jqXHR, textStatus, errorThrown) {
                      console.error("Error fetching manufacturers:", textStatus, errorThrown, jqXHR);
                      showToast("Error fetching manufacturers.", "error");
                      reject(errorThrown);
                  },
                  beforeSend: function() {
                      console.log("Sending request to fetch manufacturers.");
                  },
                  complete: function(jqXHR, textStatus) {
                      console.log("Request to fetch manufacturers completed with status:", textStatus);
                  }
              });
        });
    }
</script>
{{end}}

{{define "searchProductRow"}}
{{$permission := .Permission.Role}}
<script>
    function generateInsertRow(manufacturers, currencies, seasons) {
        console.log("Generating Search Row")
        
        // Manufacturer dropdown options
        var manufacturerOptions = '<option value="" selected>Select Manufacturer</option>';
        manufacturers.forEach(function(manufacturer) {
            manufacturerOptions += `<option value="${manufacturer.name}">${manufacturer.name}</option>`;
        });
        
        // Generate Currency Options
        var currencyOptions = '<option value="" selected>Select Currency</option>';
        currencies.forEach(function(currency) {
            currencyOptions += `<option value="${currency}">${currency}</option>`;
        });

        // Generate Seasons Options
        var seasonOptions = '<option value="None" selected>None</option>';
        seasons.forEach(function(season) {
            seasonOptions += `<option value="${season}">${season}</option>`;
        });

        // Generate the Insert Row
        var insertRow = `<tr class="table-danger">
            <td></td>
            <td><input class="form-control" type='text' id="new_sku"></td>
            <td><input class="form-control" type='text' id="new_manufacturerpart"></td>
            <td><input class="form-control" type='text' id="new_description"></td>
            {{if eq $permission "admin"}}<td><select class="form-select" id="new_manufacturer">${manufacturerOptions}</select></td>{{end}}
            {{if eq $permission "admin"}}<td><input class="form-control" type='text' id="new_processrequest"></td>{{end}}
            <td><input class="form-control" type='text' id="new_unit"></td>
            {{if eq $permission "admin"}}<td><input class="form-control" type='text' id="new_unitprice"></td>{{end}}
            {{if eq $permission "admin"}}<td><select class="form-select" id="new_currency">${currencyOptions}</select></td>{{end}}
            {{if eq $permission "admin"}}<td><input class="form-control" type='text' id="new_orderqty"></td>{{end}}
            {{if eq $permission "admin"}}<td><input class="form-check-input" type='checkbox' id="reorder" name="reorder" checked></td>{{end}}
            <td><select class="form-select" id="new_season">${seasonOptions}</select></td>
            <td><input class="form-control" type='text' id="new_inventoryqty"></td>
            <td><button class="btn btn-primary" id="btnSearch" name="btnSearch">Search</button></td>
            <td></td>
        </tr>`;
        return insertRow
    }
</script>
{{end}}

{{define "insertProductRow"}}
{{$permission := .Permission.Role}}
<script>
    function generateInsertRow(manufacturers, currencies, seasons) {
        console.log("Generating Insert Row")
        
        // Manufacturer dropdown options
        var manufacturerOptions = '<option value="" selected>Select Manufacturer</option>';
        manufacturers.forEach(function(manufacturer) {
            manufacturerOptions += `<option value="${manufacturer.name}">${manufacturer.name}</option>`;
        });
        
        // Generate Currency Options
        var currencyOptions = '<option value="" selected>Select Currency</option>';
        currencies.forEach(function(currency) {
            currencyOptions += `<option value="${currency}">${currency}</option>`;
        });

        // Generate Seasons Options
        var seasonOptions = '<option value="None" selected>None</option>';
        seasons.forEach(function(season) {
            seasonOptions += `<option value="${season}">${season}</option>`;
        });

        // Generate the Insert Row
        var insertRow = `<tr class="table-info">
            <td></td>
            <td><input class="form-control" type='text' id="new_sku"></td>
            <td><input class="form-control" type='text' id="new_manufacturerpart"></td>
            <td><input class="form-control" type='text' id="new_description"></td>
            {{if eq $permission "admin"}}<td><select class="form-select" id="new_manufacturer">${manufacturerOptions}</select></td>{{end}}
            {{if eq $permission "admin"}}<td><input class="form-control" type='text' id="new_processrequest"></td>{{end}}
            <td><input class="form-control" type='text' id="new_unit"></td>
            {{if eq $permission "admin"}}<td><input class="form-control" type='text' id="new_unitprice"></td>{{end}}
            {{if eq $permission "admin"}}<td><select class="form-select" id="new_currency">${currencyOptions}</select></td>{{end}}
            {{if eq $permission "admin"}}<td><input class="form-control" type='text' id="new_orderqty"></td>{{end}}
            {{if eq $permission "admin"}}<td><input class="form-check-input" type='checkbox' id="reorder" name="reorder" checked></td>{{end}}
            <td><select class="form-select" id="new_season">${seasonOptions}</select></td>
            <td><input class="form-control" type='text' id="new_inventoryqty"></td>
            <td><button class="btn btn-primary" id="btnInsertNew">Insert</button></td>
            <td></td>
        </tr>`;
        return insertRow
    }
</script>
{{end}}

{{define "tableProductRow"}}
{{$permission := .Permission.Role}}
<script>
    function generateTableRow(item, index, manufacturers, currencies, seasons) {
        console.log("Processing item:", index, item);
        //create a map of acceptable currencies and select the correct one
        var currencyOptions = currencies.map(function(currency) {
            return `<option value="${currency}" ${currency === item.Currency ? 'selected' : ''}>${currency}</option>`;
        }).join('');

        //Create a map of all manufacturers
        var manufacturerOptions = manufacturers.map(function(manufacturer) {
            return `<option value="${manufacturer.name}" ${manufacturer.name === item.Manufacturer ? 'selected' : ''}>${manufacturer.name}</option>`;
        }).join('');
        
        // Season dropdown options
        let seasonOptions = `<option value="" ${!seasons.includes(item.Season) ? 'selected' : ''}></option>` +
            seasons.map(season => {
                return `<option value="${season}" ${item.Season === season ? 'selected' : ''}>${season}</option>`;
            }).join('');


        var row = `<tr>
                    <td><a role="button" class="image-link" data-standard-url="${item.Image.url_standard}" data-sku="${item.SKU}"><img class="img-rounded" data-bs-toggle="modal" data-bs-target="#ModalImage0" src="${item.Image.url_tiny}" height="45px"></a></td>
                    <td><input class="form-control" type='text' id="sku" name="sku" value="${item.SKU}"></td>
                    <td><input class="form-control" type='text' id="manufacturerpart" name="manufacturerpart" value="${item.ManufacturerPart}"></td>
                    <td><input class="form-control" type='text' id="description" name="description" value="${item.Description}"></td>
                    {{if eq $permission "admin"}}<td><select class="form-select" id="manufacturer" name="manufacturer">${manufacturerOptions}</select></td>{{end}}
                    {{if eq $permission "admin"}}<td><input class="form-control" type='text' id="processrequest" name="processrequest" value="${item.ProcessRequest}"></td>{{end}}
                    <td><input class="form-control" type='text' id="unit" name="unit" value="${item.Unit}"></td>
                    {{if eq $permission "admin"}}<td><input class="form-control" type='text' id="unitprice" name="unitprice" value="${item.UnitPrice}"></td>{{end}}
                    {{if eq $permission "admin"}}<td><select class="form-select" id="currency" name="currency">${currencyOptions}</select></td>{{end}}
                    {{if eq $permission "admin"}}<td><input class="form-control" type='text' id="orderqty" name="orderqty" value="${item.OrderQty}"></td>{{end}}
                    {{if eq $permission "admin"}}<td><input class="form-check-input" type='checkbox' id="reorder" name="reorder" ${item.Reorder ? 'checked' : ''}></td>{{end}}
                    <td><select class="form-select" id="season" name="season">${seasonOptions}</select></td>
                    <td><input class="form-control" type='text' id="inventoryqty" name="inventoryqty" value="${item.InventoryQty}"></td>
                    <td><input type='button' value='Update' class='btn btn-primary update-button' data-item-id='${item.SKU}'></td>
                    <td><button type="button" class="btn btn-danger delete-button" data-item-id="${item.SKU}" data-bs-toggle="modal">Delete</button></td>
                    </tr>`;
        return row
    }
</script>
{{end}}

{{define "insertProductButton"}}
<script>
    $('#productTableBody').on('click', '#btnInsertNew', function() {
        console.log("Collecting data to insert new Product");
        var validationMessage = validateNewProductForm();
        if (validationMessage !== "") {
            showToast(validationMessage, "warning");
            return;
        }
        // Collecting input data
        var newProductData = {
            sku: $('#new_sku').val(),
            manufacturerPart: $('#new_manufacturerpart').val() || null,
            description: $('#new_description').val() || null,
            manufacturer: $('#new_manufacturer').val() || null,
            processRequest: $('#new_processrequest').val() || null,
            unit: $('#new_unit').val() || null,
            currency: $('#currency').val() || null,
            unitPrice: $('#new_unitprice').val() ? parseFloat($('#new_unitprice').val()) : null,
            orderQty: $('#new_orderqty').val() ? parseInt($('#new_orderqty').val(), 10) : null,
            reorder: $('#new_reorder').is(':checked'),
            season: $('#new_season').val() || null,
            inventoryQty: $('#new_inventoryqty').val() ? parseInt($('#new_inventoryqty').val(), 10) : null
        };

        console.log("Preparing to insert new product:", newProductData);

        // AJAX call to insert the new product
        $.ajax({
            url: '/api-handler?targetAPI=/api/productinsert', // API endpoint for product insertion
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(newProductData),
            success: function(response) {
                console.log("New product inserted successfully:", response);
                showToast("SKU inserted successfully.", "info");
                fetchAndUpdateTable() //update the table
            },
            error: function(jqXHR, textStatus, errorThrown) {
                console.error("Error inserting new product:", textStatus, errorThrown, jqXHR);
                if(jqXHR.responseText) {
                    try {
                        var resp = JSON.parse(jqXHR.responseText);
                        showToast(resp.error, "error");
                    } catch(e) {
                        showToast("Error inserting new product.", "error");
                    }
                } else {
                    showToast("Error inserting new product.", "error");
                }
            },
            beforeSend: function() {
                console.log("Sending request to insert new product.");
            },
            complete: function(jqXHR, textStatus) {
                console.log("Request to insert new product completed with status:", textStatus);
            }
        });
    });

    //Validate product insertion before submission
    function validateNewProductForm() {
                var missingFields = [];

                // Check SKU - required
                if ($('#new_sku').val().trim() === '') {
                    missingFields.push("SKU");
                }

                // Check Manufacturer Part - assuming it's required
                if ($('#new_manufacturerpart').val().trim() === '') {
                    missingFields.push("Manufacturer Part");
                }

                // Check Manufacturer - assuming it's required
                if ($('#new_manufacturer').val().trim() === '') {
                    missingFields.push("Manufacturer");
                }

                // Check Currency - assuming it's required
                if ($('#currency').val().trim() === '') {
                    missingFields.push("Currency");
                }

                // Check Unit - assuming it's required
                if ($('#new_unit').val().trim() === '') {
                    missingFields.push("Unit");
                }

                // Check Unit Price - assuming it's required and must be a valid number
                var unitPrice = $('#new_unitprice').val().trim();
                if (unitPrice === '' || isNaN(parseFloat(unitPrice))) {
                    missingFields.push("Unit Price");
                }

                // Check Order Qty - assuming it's required and must be a valid integer
                var orderQty = $('#new_orderqty').val().trim();
                if (orderQty === '' || !(/^\d+$/.test(orderQty))) {
                    missingFields.push("Order Quantity");
                }

                if (missingFields.length > 0) {
                    return "Please fill in the following required fields: " + missingFields.join(", ");
                }

                return "";
            }
</script>
{{end}}

{{define "updateProductButton"}}
<script>
    // Event listener for the update button click
    $('#productTableBody').on('click', '.update-button', function() {
        var row = $(this).closest('tr');
        var sku = $(this).data('item-id');

        var updatedProductData = {
            SKU: sku,
            ManufacturerPart: row.find('[name="manufacturerpart"]').val(),
            Description: row.find('[name="description"]').val(),
            Manufacturer: row.find('[name="manufacturer"]').val(),
            ProcessRequest: row.find('[name="processrequest"]').val(),
            Unit: row.find('[name="unit"]').val(),
            UnitPrice: parseFloat(row.find('[name="unitprice"]').val()),
            OrderQty: parseInt(row.find('[name="orderqty"]').val(), 10),
            Reorder: row.find('[name="reorder"]').is(':checked'),
            Season: row.find('[name="season"]').val(),
            InventoryQty: parseInt(row.find('[name="inventoryqty"]').val(), 10),
            Currency: row.find('[name="currency"]').val()
        };

        console.log("Preparing to update product:", updatedProductData);

        // AJAX call to update the product
        $.ajax({
            url: '/api-handler?targetAPI=/api/productupdate',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(updatedProductData),
            success: function(response) {
                console.log("Product updated successfully:", response);
                showToast("SKU updated successfully.", "info");
                fetchAndUpdateTable() //update the table
            },
            error: function(jqXHR, textStatus, errorThrown) {
                console.error("Error updating product:", textStatus, errorThrown, jqXHR);
                // Handle error
            }
        });
    });
</script>
{{end}}

{{define "btnSearch"}}
<script>
    // Event listener for the search button
    $(document).on('click', '#btnSearch', function() {
        console.log("Search button clicked");

        var searchParams = {
            sku: $('#new_sku').val(),
            manufacturerpart: $('#new_manufacturerpart').val(),
            description: $('#new_description').val(),
            manufacturer: $('#new_manufacturer').val(),
            processrequest: $('#new_processrequest').val(),
            unit: $('#new_unit').val(),
            unitprice: $('#new_unitprice').val(),
            currency: $('#new_currency').val(),
            orderqty: $('#new_orderqty').val(),
            season: $('#new_season').val(),
            inventoryqty: $('#new_inventoryqty').val()
        };

        console.log("Search Parameters:", searchParams);

        // Remove empty parameters
        Object.keys(searchParams).forEach(key => {
            if (!searchParams[key]) delete searchParams[key];
        });
        fetchAndUpdateTable(searchParams);
    });
</script>
{{end}}