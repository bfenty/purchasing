{{define "toast"}}
<script>
//Show messages to the user
function showToast(message, type) {
    console.log("Displaying Toast.",message,type)
    var toastTypeClass = '';
    switch (type) {
        case 'error': toastTypeClass = 'bg-danger'; break;
        case 'warning': toastTypeClass = 'bg-warning text-dark'; break;
        case 'info': toastTypeClass = 'bg-success'; break;
        default: toastTypeClass = 'bg-secondary';
    }

    var toastId = 'toast' + Date.now(); // Unique ID for each toast
    var toastHtml = `
        <div class="toast ${toastTypeClass}" id="${toastId}" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="5000">
            <div class="toast-body">
                ${message}
            </div>
        </div>`;

    $('#toastContainer').append(toastHtml);
    var toast = new bootstrap.Toast($('#' + toastId));
    toast.show();
    }
</script>
{{end}}

{{define "toastBox"}}
<!-- Message Box -->
<div id="toastContainer" class="toast-container position-fixed top-0 end-0 p-3">
    <!-- Toasts will be added here dynamically -->
</div>
{{end}}

{{define "fetchmanufacturers"}}
<script>
    // Fetch manufacturers
    async function fetchManufacturers() {
        return new Promise((resolve, reject) => {
            $.ajax({
                url: '/api-handler?targetAPI=/api/manufacturers',
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    console.log("Manufacturers fetched successfully. Data:", data);
                    resolve(data); // Resolve the promise with the data
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    console.error("Error during the request:", textStatus, errorThrown, jqXHR);
                    var errorMessage = "Error during the request.";
                    
                    // Try to parse and use the custom error message from the server if available
                    if (jqXHR.responseText) {
                        try {
                            var resp = JSON.parse(jqXHR.responseText);
                            if (resp && resp.error) {
                                errorMessage = resp.error;
                            }
                        } catch (e) {
                            console.error("Error parsing server response:", e);
                        }
                    }
                    showToast(errorMessage, "error");  // Show the custom error message
                }
            });
        });
    }
</script>
{{end}}

{{define "searchProductRow"}}
{{$permission := .Permission.Role}}
<script>
    function GenerateTopRow(manufacturers, currencies, seasons) {
        console.log("Generating Search Row")
        
        // Manufacturer dropdown options
        var manufacturerOptions = '<option value="" selected>Select Manufacturer</option>';
        manufacturers.forEach(function(manufacturer) {
            manufacturerOptions += `<option value="${manufacturer.name}">${manufacturer.name}</option>`;
        });
        
        // Generate Currency Options
        var currencyOptions = '<option value="" selected>Select Currency</option>';
        currencies.forEach(function(currency) {
            currencyOptions += `<option value="${currency}">${currency}</option>`;
        });

        // Generate Seasons Options
        var seasonOptions = '<option value="" selected>None</option>';
        seasons.forEach(function(season) {
            seasonOptions += `<option value="${season}">${season}</option>`;
        });

        // Generate the Insert Row
        var insertRow = `<tr class="table-danger">
            <td></td>
            <td><input class="form-control" type='text' id="sku"></td>
            <td><input class="form-control" type='text' id="manufacturerpart"></td>
            <td><input class="form-control" type='text' id="description"></td>
            {{if eq $permission "admin"}}<td><select class="form-select" id="manufacturer">${manufacturerOptions}</select></td>{{end}}
            {{if eq $permission "admin"}}<td><input class="form-control" type='text' id="processrequest"></td>{{end}}
            <td><input class="form-control" type='text' id="unit"></td>
            {{if eq $permission "admin"}}<td><input class="form-control" type='text' id="unitprice"></td>{{end}}
            {{if eq $permission "admin"}}<td><select class="form-select" id="currency">${currencyOptions}</select></td>{{end}}
            {{if eq $permission "admin"}}<td><input class="form-control" type='text' id="orderqty"></td>{{end}}
            {{if eq $permission "admin"}}<td><input class="form-check-input" type='checkbox' id="reorder" name="reorder" checked></td>{{end}}
            <td><select class="form-select" id="season">${seasonOptions}</select></td>
            <td><input class="form-control" type='text' id="new_inventoryqty"></td>
            <td><button class="btn btn-primary" id="btnSearch">Search</button></td>
            <td></td>
        </tr>`;
        return insertRow
    }
</script>
{{end}}

{{define "searchCustomerRow"}}
<script>
    function GenerateTopRow() {
        console.log("Generating Search Row")

        // Generate the Insert Row
        var insertRow = `
        <tr class="search-row">
            <td><input class="form-control" type="text" id="customer_email" ></td>
            <td><input class="form-control" type="text" id="first_name" </td>
            <td><input class="form-control" type="text" id="last_name" ></td>
            <td><input class="form-control" type="text" id="country" ></td>
            <td><input class="form-control" type="text" id="rebill_day" ></td>
            <td><input class="form-control" type="text" id="rebill_months" ></td>
            <td><input class="form-control" type="text" id="autorenew" ></td>
            <td><input class="form-control" type="text" id="cratejoy_status" ></td>
            <td><input class="form-control" type="text" id="start_date" ></td>
            <td><input class="form-control" type="text" id="end_date" ></td>
            <td><input class="form-control" type="text" id="mailchimp_status"></td>
            <td><button class="btn btn-primary" id="btnSearch">Search</button></td>
            <td></td>
        </tr>
        `;

        // Returning the row HTML
        return insertRow;
    }
</script>
{{end}}

{{define "insertProductRow"}}
{{$permission := .Permission.Role}}
<script>
    function GenerateTopRow(manufacturers, currencies, seasons) {
        console.log("Generating Insert Row")
        
        // Manufacturer dropdown options
        var manufacturerOptions = '<option value="" selected>Select Manufacturer</option>';
        manufacturers.forEach(function(manufacturer) {
            manufacturerOptions += `<option value="${manufacturer.name}">${manufacturer.name}</option>`;
        });
        
        // Generate Currency Options
        var currencyOptions = '<option value="" selected>Select Currency</option>';
        currencies.forEach(function(currency) {
            currencyOptions += `<option value="${currency}">${currency}</option>`;
        });

        // Generate Seasons Options
        var seasonOptions = '<option value="None" selected>None</option>';
        seasons.forEach(function(season) {
            seasonOptions += `<option value="${season}">${season}</option>`;
        });

        // Generate the Insert Row
        var insertRow = `<tr class="table-info">
            <td></td>
            <td><input class="form-control" type='text' id="new_sku"></td>
            <td><input class="form-control" type='text' id="new_manufacturerpart"></td>
            <td><input class="form-control" type='text' id="new_description"></td>
            {{if eq $permission "admin"}}<td><select class="form-select" id="new_manufacturer">${manufacturerOptions}</select></td>{{end}}
            {{if eq $permission "admin"}}<td><input class="form-control" type='text' id="new_processrequest"></td>{{end}}
            <td><input class="form-control" type='text' id="new_unit"></td>
            {{if eq $permission "admin"}}<td><input class="form-control" type='text' id="new_unitprice"></td>{{end}}
            {{if eq $permission "admin"}}<td><select class="form-select" id="new_currency">${currencyOptions}</select></td>{{end}}
            {{if eq $permission "admin"}}<td><input class="form-control" type='text' id="new_orderqty"></td>{{end}}
            {{if eq $permission "admin"}}<td><input class="form-check-input" type='checkbox' id="new_reorder" name="new_reorder" checked></td>{{end}}
            <td><select class="form-select" id="new_season">${seasonOptions}</select></td>
            <td><input class="form-control" type='text' id="new_inventoryqty"></td>
            <td><button class="btn btn-primary" id="btnInsertNew">Insert</button></td>
            <td></td>
        </tr>`;
        return insertRow
    }
</script>
{{end}}

{{define "tableProductRow"}}
{{$permission := .Permission.Role}}
<script>
    function generateTableRow(item, index, manufacturers, currencies, seasons) {
        // console.log("Processing item:", index, item);
        //create a map of acceptable currencies and select the correct one
        var currencyOptions = currencies.map(function(currency) {
            return `<option value="${currency}" ${currency === item.Currency ? 'selected' : ''}>${currency}</option>`;
        }).join('');

        //Create a map of all manufacturers
        var manufacturerOptions = manufacturers.map(function(manufacturer) {
            return `<option value="${manufacturer.name}" ${manufacturer.name === item.Manufacturer ? 'selected' : ''}>${manufacturer.name}</option>`;
        }).join('');
        
        // Season dropdown options
        let seasonOptions = `<option value="" ${!seasons.includes(item.Season) ? 'selected' : ''}></option>` +
            seasons.map(season => {
                return `<option value="${season}" ${item.Season === season ? 'selected' : ''}>${season}</option>`;
            }).join('');


        var row = `<tr>
                    <td><a role="button" class="image-link" data-standard-url="${item.Image.url_standard}" data-sku="${item.SKU}"><img class="img-rounded" data-bs-toggle="modal" data-bs-target="#ModalImage0" src="${item.Image.url_tiny}" height="45px"></a></td>
                    <td><input class="form-control" type='text' id="sku" name="sku" value="${item.SKU}"></td>
                    <td><input class="form-control" type='text' id="manufacturerpart" name="manufacturerpart" value="${item.ManufacturerPart}"></td>
                    <td><input class="form-control" type='text' id="description" name="description" value="${item.Description}"></td>
                    {{if eq $permission "admin"}}<td><select class="form-select" id="manufacturer" name="manufacturer">${manufacturerOptions}</select></td>{{end}}
                    {{if eq $permission "admin"}}<td><input class="form-control" type='text' id="processrequest" name="processrequest" value="${item.ProcessRequest}"></td>{{end}}
                    <td><input class="form-control" type='text' id="unit" name="unit" value="${item.Unit}"></td>
                    {{if eq $permission "admin"}}<td><input class="form-control" type='text' id="unitprice" name="unitprice" value="${item.UnitPrice}"></td>{{end}}
                    {{if eq $permission "admin"}}<td><select class="form-select" id="currency" name="currency">${currencyOptions}</select></td>{{end}}
                    {{if eq $permission "admin"}}<td><input class="form-control" type='text' id="orderqty" name="orderqty" value="${item.OrderQty}"></td>{{end}}
                    {{if eq $permission "admin"}}<td><input class="form-check-input" type='checkbox' id="reorder" name="reorder" ${item.Reorder ? 'checked' : ''}></td>{{end}}
                    <td><select class="form-select" id="season" name="season">${seasonOptions}</select></td>
                    <td><input class="form-control" type='text' id="inventoryqty" name="inventoryqty" value="${item.InventoryQty}"></td>
                    <td><input type='button' value='Update' class='btn btn-primary update-button' data-item-id='${item.SKU}'></td>
                    <td><button type="button" class="btn btn-danger delete-button" data-item-id="${item.SKU}" data-bs-toggle="modal">Delete</button></td>
                    </tr>`;
        return row
    }
</script>
{{end}}

{{define "btninsertProduct"}}
<script>
    $('#contentTableBody').on('click', '#btnInsertNew', function() {
        console.log("Collecting data to insert new Product");
        var validationMessage = validateNewProductForm();
        if (validationMessage !== "") {
            showToast(validationMessage, "warning");
            return;
        }
        // Collecting input data
        var newProductData = {
            sku: $('#new_sku').val(),
            manufacturerPart: $('#new_manufacturerpart').val() || null,
            description: $('#new_description').val() || null,
            manufacturer: $('#new_manufacturer').val() || null,
            processRequest: $('#new_processrequest').val() || null,
            unit: $('#new_unit').val() || null,
            currency: $('#new_currency').val() || null,
            unitPrice: $('#new_unitprice').val() ? parseFloat($('#new_unitprice').val()) : null,
            orderQty: $('#new_orderqty').val() ? parseInt($('#new_orderqty').val(), 10) : null,
            reorder: $('#new_reorder').is(':checked'),
            season: $('#new_season').val() || null,
            inventoryQty: $('#new_inventoryqty').val() ? parseInt($('#new_inventoryqty').val(), 10) : null
        };

        console.log("Preparing to insert new product:", newProductData);

        // AJAX call to insert the new product
        $.ajax({
            url: '/api-handler?targetAPI=/api/productinsert', // API endpoint for product insertion
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(newProductData),
            success: function(response) {
                console.log("New product inserted successfully:", response);
                showToast("SKU inserted successfully.", "info");
                fetchAndUpdateTable(); //update the table
            },
            error: function(jqXHR, textStatus, errorThrown) {
                console.error("Error during the request:", textStatus, errorThrown, jqXHR);
                var errorMessage = "Error during the request.";
                
                // Try to parse and use the custom error message from the server if available
                if (jqXHR.responseText) {
                    try {
                        var resp = JSON.parse(jqXHR.responseText);
                        if (resp && resp.error) {
                            errorMessage = resp.error;
                        }
                    } catch (e) {
                        console.error("Error parsing server response:", e);
                    }
                }
                showToast(errorMessage, "error");  // Show the custom error message
            },
            beforeSend: function() {
                console.log("Sending request to insert new product.");
            },
            complete: function(jqXHR, textStatus) {
                console.log("Request to insert new product completed with status:", textStatus);
            }
        });
    });

    //Validate product insertion before submission
    function validateNewProductForm() {
                var missingFields = [];

                // Check SKU - required
                if ($('#new_sku').val().trim() === '') {
                    missingFields.push("SKU");
                }

                // Check Manufacturer Part - assuming it's required
                if ($('#new_manufacturerpart').val().trim() === '') {
                    missingFields.push("Manufacturer Part");
                }

                // Check Manufacturer - assuming it's required
                if ($('#new_manufacturer').val().trim() === '') {
                    missingFields.push("Manufacturer");
                }

                // Check Currency - assuming it's required
                if ($('#currency').val().trim() === '') {
                    missingFields.push("Currency");
                }

                // Check Unit - assuming it's required
                if ($('#new_unit').val().trim() === '') {
                    missingFields.push("Unit");
                }

                // Check Unit Price - assuming it's required and must be a valid number
                var unitPrice = $('#new_unitprice').val().trim();
                if (unitPrice === '' || isNaN(parseFloat(unitPrice))) {
                    missingFields.push("Unit Price");
                }

                // Check Order Qty - assuming it's required and must be a valid integer
                var orderQty = $('#new_orderqty').val().trim();
                if (orderQty === '' || !(/^\d+$/.test(orderQty))) {
                    missingFields.push("Order Quantity");
                }

                if (missingFields.length > 0) {
                    return "Please fill in the following required fields: " + missingFields.join(", ");
                }

                return "";
            }
</script>
{{end}}

{{define "btnupdateProduct"}}
<script>
    // Event listener for the update button click
    $('#contentTableBody').on('click', '.update-button', function() {
        var row = $(this).closest('tr');
        var sku = $(this).data('item-id');

        var updatedProductData = {
            SKU: sku,
            ManufacturerPart: row.find('[name="manufacturerpart"]').val(),
            Description: row.find('[name="description"]').val(),
            Manufacturer: row.find('[name="manufacturer"]').val(),
            ProcessRequest: row.find('[name="processrequest"]').val(),
            Unit: row.find('[name="unit"]').val(),
            UnitPrice: parseFloat(row.find('[name="unitprice"]').val()),
            OrderQty: parseInt(row.find('[name="orderqty"]').val(), 10),
            Reorder: row.find('[name="reorder"]').is(':checked'),
            Season: row.find('[name="season"]').val(),
            InventoryQty: parseInt(row.find('[name="inventoryqty"]').val(), 10),
            Currency: row.find('[name="currency"]').val()
        };

        console.log("Preparing to update product:", updatedProductData);

        // AJAX call to update the product
        $.ajax({
            url: '/api-handler?targetAPI=/api/productupdate',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(updatedProductData),
            success: function(response) {
                console.log("Product updated successfully:", response);
                showToast("SKU updated successfully.", "info");
                fetchAndUpdateTable(); //update the table
            },
            error: function(jqXHR, textStatus, errorThrown) {
                console.error("Error during the request:", textStatus, errorThrown, jqXHR);
                var errorMessage = "Error during the request.";
                
                // Try to parse and use the custom error message from the server if available
                if (jqXHR.responseText) {
                    try {
                        var resp = JSON.parse(jqXHR.responseText);
                        if (resp && resp.error) {
                            errorMessage = resp.error;
                        }
                    } catch (e) {
                        console.error("Error parsing server response:", e);
                    }
                }
                showToast(errorMessage, "error");  // Show the custom error message
            }
        });
    });
</script>
{{end}}

{{define "btnSearch"}}
<script>
    // Event listener for the search button
    var searchParams = {};
    $('#contentTableBody').on('click', '#btnSearch', function() {
        console.log("Search button clicked");
        // Construct searchParams object from input values
        $('#btnSearch').closest('tr').find('input').each(function() {
            // Use the input's id as the key and the input's value as the value
            var key = $(this).attr('id');
            var value = $(this).val();

            // Add key-value pair to searchParams object if the value is not empty
            if (value) {
                searchParams[key] = value;
            }
        });
        // Fetch and update the table based on the search parameters
        fetchAndUpdateTable(1, limit, searchParams);  // Reset to page 1 for new search
    });

    // Optional: Trigger search when pressing 'Enter' in any search field
    $('.search-row input').keypress(function(event) {
        if (event.which == 13) {  // 'Enter' key code
            $('#searchBtn').click();
        }
    });
</script>
{{end}}

{{define "btnDeleteSKU"}}
<script>
    var currentItemToDelete; // Global variable to store the current item to delete

    // Event handler for delete button clicks
    $(document).on('click', '.delete-button', function() {
        var itemId = $(this).data('item-id');
        currentItemToDelete = itemId;

        // Show the delete modal
        var deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
        $('#deleteItemID').text(itemId);
        $('#deleteModalLabel').text("Confirm Delete");
        $('#deleteModalText').text("Are you sure you want to delete the item with SKU: ");
            deleteModal.show();
    });

    // Event handler for the confirm delete action
    $('#confirmDelete').click(function() {
        console.log("Initiating delete request for item:", currentItemToDelete);

        $.ajax({
            url: '/api-handler?targetAPI=/api/productdelete',
            type: 'POST',
            contentType: 'application/json',  // Ensure JSON content type
            dataType: 'json',
            data: JSON.stringify({ sku: currentItemToDelete }), // Convert data to JSON string
            success: function(response) {
                console.log("Item deleted successfully:", response);
                showToast("SKU deleted successfully.", "info");
                fetchAndUpdateTable();  // Refresh the table data
            },
            error: function(jqXHR, textStatus, errorThrown) {
                console.error("Error during the request:", textStatus, errorThrown, jqXHR);
                var errorMessage = "Error during the request.";
                
                // Try to parse and use the custom error message from the server if available
                if (jqXHR.responseText) {
                    try {
                        var resp = JSON.parse(jqXHR.responseText);
                        if (resp && resp.error) {
                            errorMessage = resp.error;
                        }
                    } catch (e) {
                        console.error("Error parsing server response:", e);
                    }
                }
                showToast(errorMessage, "error");  // Show the custom error message
            },
            beforeSend: function() {
                console.log("Sending delete request to /api/productdelete.");
            },
            complete: function(jqXHR, textStatus) {
                console.log("Delete request completed with status:", textStatus);
                $('#deleteModal').modal('hide'); // Hide the modal after completion
            }
        });
    });
</script>
{{end}}

{{define "btnDeleteUser"}}
<script>
    var currentItemToDelete; // Global variable to store the current item to delete

    // Event handler for delete button clicks
    $(document).on('click', '.delete-button', function() {
        var itemId = $(this).data('item-id');
        currentItemToDelete = itemId;

        // Show the delete modal
        var deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
        $('#deleteItemID').text(itemId);
        $('#deleteModalLabel').text("Confirm User Delete");
        $('#deleteModalText').text("Are you sure you want to delete User: ");
            deleteModal.show();
    });

    // Event handler for the confirm delete action
    $('#confirmDelete').click(function() {
        console.log("Initiating delete request for user:", currentItemToDelete);

        $.ajax({
            url: '/api-handler?targetAPI=/api/userdelete',
            type: 'POST',
            contentType: 'application/json',  // Ensure JSON content type
            dataType: 'json',
            data: JSON.stringify({ usercode: currentItemToDelete }), // Send usercode for deletion
            success: function(response) {
                console.log("User deleted successfully:", response);
                showToast("User deleted successfully.", "info");
                fetchAndUpdateTable();  // Refresh the user table
            },
            error: function(jqXHR, textStatus, errorThrown) {
                console.error("Error during the request:", textStatus, errorThrown, jqXHR);
                var errorMessage = "Error during the request.";
                
                // Try to parse and use the custom error message from the server if available
                if (jqXHR.responseText) {
                    try {
                        var resp = JSON.parse(jqXHR.responseText);
                        if (resp && resp.error) {
                            errorMessage = resp.error;
                        }
                    } catch (e) {
                        console.error("Error parsing server response:", e);
                    }
                }
                showToast(errorMessage, "error");  // Show the custom error message
            },
            beforeSend: function() {
                console.log("Sending delete request to /api/userdelete.");
            },
            complete: function(jqXHR, textStatus) {
                console.log("Delete request completed with status:", textStatus);
                $('#deleteModal').modal('hide'); // Hide the modal after completion
            }
        });
    });
</script>
{{end}}

{{define "updateTable"}}
<script>
     // Function to fetch and update table data
    async function fetchAndUpdateTable(currentPage, limit,searchParams = {}) {
        // Get manufacturers data
        try {
            console.log("Fetching manufacturers...");
            const manufacturers = await fetchManufacturers(); // Wait for manufacturers to be fetched
            console.log("Manufacturers fetched:", manufacturers);

            // Construct the query string from search parameters
            var limit = $('#limitSelect').val();
            var queryParams = $.param(searchParams); // Convert search parameters to query string
            var apiUrl = `/api-handler?targetAPI=/api/products&page=${currentPage}&limit=${limit}&${queryParams}`;
            console.log("Fetching data with search parameters:", searchParams);

            console.log("Fetching data from " + apiUrl);
            $.ajax({
                url: apiUrl,
                type: 'GET',
                dataType: 'json',
                success: function(response) {
                    console.log("Data fetched successfully. Number of records:", response.products.length);
                    console.log("Response:", response);
                    totalPages = response.totalPages; // set the total pages from the response
                    currentPage = response.currentPage; // set the current page from the response

                    var tableBody = $('#contentTableBody');
                    tableBody.empty(); // Clear existing data

                    // Currency dropdown options
                    var currencies = ["USD", "CZK", "EUR", "GBP"];

                    // Season dropdown options
                    var seasons = ['None', 'Christmas', 'Fall', 'Halloween'];

                    // Add the insert row at the beginning
                    var insertRow = GenerateTopRow(manufacturers, currencies, seasons);
                    tableBody.append(insertRow);

                    response.products.forEach(function(item, index) {
                        var row = generateTableRow(item, index, manufacturers, currencies, seasons);
                        tableBody.append(row);
                    });

                    $('#loadingSpinner').hide(); // Hide the spinner

                    // Update pagination controls
                    updatePaginationControls();

                    console.log("Table updated successfully.");
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    console.error("Error during the request:", textStatus, errorThrown, jqXHR);
                    var errorMessage = "Error during the request.";

                    // Try to parse and use the custom error message from the server if available
                    if (jqXHR.responseText) {
                        try {
                            var resp = JSON.parse(jqXHR.responseText);
                            if (resp && resp.error) {
                                errorMessage = resp.error;
                            }
                        } catch (e) {
                            console.error("Error parsing server response:", e);
                        }
                    }
                    showToast(errorMessage, "error");  // Show the custom error message
                },
                beforeSend: function() {
                    console.log("Preparing to send AJAX request to /api/products.");
                    $('#loadingSpinner').show(); // Show the spinner before sending the request
                },
                complete: function(jqXHR, textStatus) {
                    console.log("AJAX request completed with status:", textStatus);
                }
            });
        } catch (error) {
            console.error("Error in fetching manufacturers:", error);
            showToastF(error,"error")
            // Handle the error
        }
    }
  </script>
{{end}}

{{define "updateSortTable"}}
{{$permission := .Permission.Role}}
{{$layout := .Layout}}
{{$admin := .Permission.Permissions.Admin}}
{{$mgmt := .Permission.Permissions.Mgmt}}
<script>
    // Fetch users
    async function fetchUsers() {
        return new Promise((resolve, reject) => {
            $.ajax({
                url: '/api-handler?targetAPI=/api/users&limit=100', // Using the users API endpoint
                type: 'GET',
                dataType: 'json',
                success: function(response) {
                    console.log("Users fetched successfully. Data:", response);
                    // Assuming `response` includes a property `users` which is an array of user objects
                    const usernames = response.users.map(user => user.Username); // Extract usernames
                    resolve(usernames); // Resolve the promise with the array of usernames
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    console.error("Error fetching users:", textStatus, errorThrown, jqXHR);
                    let errorMessage = "Error fetching users.";
                    
                    if (jqXHR.responseText) {
                        try {
                            let resp = JSON.parse(jqXHR.responseText);
                            if (resp && resp.error) {
                                errorMessage = resp.error;
                            }
                        } catch (e) {
                            console.error("Error parsing server response:", e);
                        }
                    }
                    reject(errorMessage); // Reject the promise with the error message
                }
            });
        });
    }
</script>
<script>
    async function fetchAndUpdateTable(currentPage, limit,searchParams = {}) {
        // Get Users Data
        try {
            console.log("Fetching users...");
            const users = await fetchUsers(); // Wait for users to be fetched
            console.log("Users fetched:", users);

            // Construct the query string from search parameters
            var limit = $('#limitSelect').val();
            var queryParams = $.param(searchParams); // Convert search parameters to query string
            var apiUrl = `/api-handler?targetAPI=/api/sortinglist&page=${currentPage}&limit=${limit}&${queryParams}`;
            console.log("Fetching data with search parameters:", searchParams);

            console.log("Fetching data from " + apiUrl);

            $.ajax({
                url: apiUrl,
                type: 'GET',
                dataType: 'json',
                success: function(response) {
                    console.log("Data fetched successfully. Number of records:", response.sortRequests.length);
                    console.log("Response:", response);
                    totalPages = response.totalPages; // set the total pages from the response
                    currentPage = response.currentPage; // set the current page from the response
                    // Update the customer table with the new data
                    updateTable(response.sortRequests,users);
                    $('#loadingSpinner').hide(); // Hide the spinner
                    updatePaginationControls();
                    console.log("Sort Request table updated successfully.");
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    $('#loadingSpinner').hide(); // Hide the spinner
                    console.error("Error fetching data:", textStatus, errorThrown, jqXHR);

                    // Initialize errorMessage with a default error message
                    let errorMessage = "An error occurred. Please try again.";

                    // Try to parse and use the custom error message from the server if available
                    if (jqXHR.responseText) {
                        try {
                            var resp = JSON.parse(jqXHR.responseText);
                            if (resp && resp.error) {
                                errorMessage = resp.error;
                            }
                        } catch (e) {
                            console.error("Error parsing server response:", e);
                        }
                    }
                    
                    showToast(errorMessage, "error");  // Show the custom error message or the default one
                },

                beforeSend: function() {
                    console.log("Preparing to send AJAX request to /api/sortrequests.");
                    $('#loadingSpinner').show(); // Show the spinner before sending the request
                },
                complete: function(jqXHR, textStatus) {
                    console.log("AJAX request completed with status:", textStatus);
                    // You can remove the loading spinner here
                }
            });
        } catch (error) {
            console.error("Error in fetching users:", error);
            showToast(error,"error")
            // Handle the error
        }
    }

    function updateTable(sortRequests,users) {
        var tableBody = $('#contentTableBody');
        tableBody.empty(); // Clear existing data

        // Add the insert row at the beginning
        var insertRow = GenerateTopRow(users);
        tableBody.append(insertRow);

        // Loop through the rows
        sortRequests.forEach(function(sortRequest) {
            var row = generateTableRow(sortRequest,users);
            tableBody.append(row);
        });
    }

    function GenerateTopRow(users) {
        console.log("Generating Search Row")

        // Manufacturer dropdown options
        var userOptions = '<option value="" selected>Select Sorter</option>';
        users.forEach(function(user) {
            userOptions += `<option value="${user}">${user}</option>`;
        });
        
        // Generate the Search Row
        var rowHtml = `
            <tr>
                <td><input type="text" class="form-control" name="search-requestid" placeholder="Request ID"></td>`;
                {{if or (eq $layout "full") (eq $layout "receiving") (eq $layout "dataentry") (eq $layout "mgmt")}}rowHtml += `<td class="col-sku"><input type="text" class="form-control" name="search-sku" placeholder="SKU"></td>`;{{end}}
                {{if or (eq $layout "full") (eq $layout "receiving") (eq $layout "dataentry")}}rowHtml += `<td><input type="text" class="form-control" name="search-description" placeholder="Description"></td>`;{{end}}
                {{if or (eq $layout "full") (eq $layout "dataentry")}}rowHtml += `<td><input type="text" class="form-control" name="search-manufacturerpart" placeholder="Manufacturer Part"></td>`;{{end}}
                {{if or (eq $layout "full") (eq $layout "receiving") (eq $layout "dataentry") (eq $layout "mgmt")}}rowHtml += `<td><input type="text" class="form-control" name="search-instructions" pattern="[0-9]+(\.[0-9]+)?" title="Please enter a valid decimal number" placeholder="Pieces"></td>`;{{end}}
                {{if or (eq $layout "full") (eq $layout "receiving") (eq $layout "dataentry")}}rowHtml += `<td><input type="text" class="form-control" name="search-weightout" placeholder="Weight Out"></td>`;{{end}}
                {{if or (eq $layout "full") (eq $layout "receiving")}}rowHtml += `<td><input type="text" class="form-control" name="search-weightin" placeholder="Weight In"></td>`;{{end}}
                {{if or (eq $layout "full") (eq $layout "receiving")}}
                rowHtml += `<td>
                    <select class="form-select" name="search-difference">
                        <option value="">Difference</option>
                        <option value="positive">Positive</option>
                        <option value="negative">Negative</option>
                    </select>
                    </td>`;
                {{end}}
                {{if or (eq $layout "full") (eq $layout "receiving")}}rowHtml += `<td></td>`;{{end}}
                {{if or (eq $layout "full") (eq $layout "receiving") (eq $layout "mgmt")}}rowHtml += `<td><input type="text" class="form-control" name="search-pieces" pattern="[0-9]+(\.[0-9]+)?" title="Please enter a valid decimal number" placeholder="Units"></td>`;{{end}}
                {{if or (eq $layout "full") (eq $layout "receiving") (eq $layout "mgmt")}}rowHtml += `<td><input type="text" class="form-control" name="search-hours" placeholder="Hours"></td>`;{{end}}
                {{if or (eq $layout "full") (eq $layout "mgmt")}}rowHtml += `<td><input type="text" class="form-control" name="search-checkout" placeholder="Check Out"></td>`;{{end}}
                {{if or (eq $layout "full") (eq $layout "mgmt")}}rowHtml += `<td><input type="text" class="form-control" name="search-checkin" placeholder="Check In"></td>`;{{end}}
                {{if or (eq $layout "full") (eq $layout "mgmt")}}
                    rowHtml += `<td>
                        <select class="form-select" name="search-sorter">
                            ${userOptions}
                        </select>
                    </td>`;
                {{end}}
                {{if or (eq $layout "full")}}
                    rowHtml += `<td>
                        <select class="form-select" name="search-status">
                            <option value="">Status</option>
                            <option value="New">New</option>
                            <option value="Checkout">Checkout</option>
                            <option value="Checkin">Checkin</option>
                        </select>
                    </td>`;
                {{end}}
                {{if or (eq $layout "full") (eq $layout "dataentry")}}
                rowHtml += `<td>
                  <select class="form-select" name="search-priority">
                    <option value="">Priority</option>
                    <option value="0">Normal</option>
                    <option value="1">High</option>
                  </select>
                </td>`;
                {{end}}
                {{if or (eq $layout "full") (eq $layout "receiving") (eq $layout "dataentry") (eq $layout "mgmt")}}rowHtml += `<td class="btn-col"><input type=hidden name=layout id=layout><input type='submit' value='Search' class="btn btn-primary"></td>`;{{end}}
                {{if or (eq $layout "full") (eq $layout "mgmt")}}rowHtml += `<td class="btn-col"></td>`;{{end}}
                {{if or (eq $layout "full") (eq $layout "receiving") (eq $layout "mgmt")}}rowHtml += `<td class="btn-col"></td>`;{{end}}
                rowHtml += `</tr>`;

                // Generate the Insert row
                rowHtml += `<tr>
                <td></td>`
                {{if or (eq $layout "full") (eq $layout "receiving") (eq $layout "dataentry") (eq $layout "mgmt")}}rowHtml += `<td class="col-sku"><input type="text" class="form-control sku" id="sku" name="sku" placeholder="SKU"></td>`{{end}}
                {{if or (eq $layout "full") (eq $layout "receiving") (eq $layout "dataentry")}}rowHtml += `<td><input type="text" class="form-control description" id="description" name="description" placeholder="Description"></td>`{{end}}
                {{if or (eq $layout "full") (eq $layout "dataentry")}}rowHtml += `<td><input type="text" class="form-control manufacturerpart" id="manufacturerpart" name="manufacturerpart" placeholder="Manufacturer Part"></td>`{{end}}
                {{if or (eq $layout "full") (eq $layout "receiving") (eq $layout "dataentry") (eq $layout "mgmt")}}rowHtml += `<td><div class="input-group"><input type="text" class="form-control instructions" id="instructions" name="instructions" pattern="[0-9]+(\.[0-9]+)?" title="Please enter a valid decimal number" placeholder="Pieces"></div></td>`{{end}}
                {{if or (eq $layout "full") (eq $layout "receiving") (eq $layout "dataentry")}}rowHtml += `<td><div class="input-group"><input type="text" class="form-control weightout" id="weightout" name="weightout" placeholder="Weight Out"></div></td>`{{end}}
                {{if or (eq $layout "full") (eq $layout "receiving")}}rowHtml += `<td><div class="input-group"><input type="text" class="form-control weightin" id="weightin" name="weightin" placeholder="Weight In"></div></td>`{{end}}
                {{if or (eq $layout "full") (eq $layout "receiving")}}rowHtml += `<td><div class="input-group"><input type="text" class="form-control difference" id="difference" name="difference" readonly placeholder="Difference"></div></td>`{{end}}
                {{if or (eq $layout "full") (eq $layout "receiving")}}rowHtml += `<td></td>`{{end}}
                {{if or (eq $layout "full") (eq $layout "receiving") (eq $layout "mgmt")}}rowHtml += `<td><div class="input-group"><input type="text" class="form-control pieces" id="pieces" name="pieces" pattern="[0-9]+(\.[0-9]+)?" title="Please enter a valid decimal number" placeholder="Pieces"></div></td>`{{end}}
                {{if or (eq $layout "full") (eq $layout "receiving") (eq $layout "mgmt")}}rowHtml += `<td><input type="text" class="form-control hours" id="hours" name="hours" placeholder="Hours"></td>`{{end}}
                {{if or (eq $layout "full") (eq $layout "mgmt")}}rowHtml += `<td><input type="date" class="form-control checkout" id="checkout" name="checkout" placeholder="Checkout Date"></td>`{{end}}
                {{if or (eq $layout "full") (eq $layout "mgmt")}}rowHtml += `<td><input type="date" class="form-control checkin" id="checkin" name="checkin" placeholder="Checkin Date"></td>`{{end}}
                {{if or (eq $layout "full") (eq $layout "mgmt")}}
                rowHtml += `<td>
                  <select class="form-select" id="sorter" name="sorter">
                            ${userOptions}
                  </select>
                </td>`
                {{end}}
                {{if or (eq $layout "full")}}
                rowHtml += `<td>
                  <select class="form-select" id="status" name="status">
                    <option selected disabled value="">Status</option>
                    <option value="New">New</option>
                    <option value="Checkout">Checkout</option>
                    <option value="Checkin">Checkin</option>
                  </select>
                </td>`
                {{end}}
                {{if or (eq $layout "full") (eq $layout "dataentry")}}
                rowHtml += `<td>
                  <select class="form-select" id="prty" name="prty">
                    <option selected disabled value="">Priority</option>
                    <option value="0">Normal</option>
                    <option value="1">High</option>
                  </select>
                </td>`
                {{end}}
                {{if or (eq $layout "full") (eq $layout "receiving") (eq $layout "dataentry") (eq $layout "mgmt")}}rowHtml += `<td class="btn-col"><input type='hidden' id='requestid' name='requestid' value=''><input type='hidden' id='active' name='active' value='1'><input type='submit' value='Insert' class="btn btn-primary update-request"></td>`{{end}}
                {{if or (eq $layout "full") ($mgmt)}}rowHtml += `<td class="btn-col"></td>`{{end}}
                {{if or (eq $layout "full") (eq $layout "receiving") (eq $layout "mgmt")}}rowHtml += `<td class="btn-col"></td>`{{end}}
                rowHtml += `</tr>`
        return rowHtml;
    }

    function generateTableRow(sortRequest, users) {
        //Strip percentage from percent
        let differencePercent = parseFloat(sortRequest.DifferencePercent.replace('%', ''));

        // Check if the absolute value is greater than 10
        let rowClass = '';
        if (Math.abs(differencePercent) > 20) {
            rowClass = 'table-danger';
        } else if (Math.abs(differencePercent) > 10) {
            rowClass = 'table-warning';
        }
        
        // Manufacturer dropdown options
        var userOptions = '<option value="" selected>Select Sorter</option>';
        users.forEach(function(user) {
            userOptions += `<option value="${user}" ${sortRequest.Sorter = user ? 'selected' : ''}>${user}</option>`;
        });
        // Constructing the row HTML
        var rowHtml = `<tr class="${rowClass}">`
            rowHtml += `<td><input type="text" class="form-control requestid" id="requestid" name="requestid" value="${sortRequest.ID}"></td>`
                  {{if or (eq $layout "full") (eq $layout "receiving") (eq $layout "dataentry") (eq $layout "mgmt")}}rowHtml += `<td class="col-sku"><input type="text" class="form-control sku" id="sku" name="sku" value="${sortRequest.SKU}"></td>`{{end}}
                  {{if or (eq $layout "full") (eq $layout "receiving") (eq $layout "dataentry")}}rowHtml += `<td><input type="text" class="form-control description" id="description" name="description" value="${sortRequest.Description}"></td>`{{end}}
                  {{if or (eq $layout "full") (eq $layout "dataentry")}}rowHtml += `<td><input type="text" class="form-control manufacturerpart" id="manufacturerpart" name="manufacturerpart" value="${sortRequest.ManufacturerPart}"></td>`{{end}}
                  {{if or (eq $layout "full") (eq $layout "receiving") (eq $layout "dataentry") (eq $layout "mgmt")}}rowHtml += `<td><div class="input-group"><input type="text" class="form-control instructions" id="instructions" name="instructions" pattern="[0-9]+(\.[0-9]+)?" title="Please enter a valid decimal number" value="${sortRequest.Instructions}"></div></td>`{{end}}
                  {{if or (eq $layout "full") (eq $layout "receiving") (eq $layout "dataentry")}}rowHtml += `<td><div class="input-group"><input type="text" class="form-control weightout" id="weightout" name="weightout" value="${sortRequest.Weightout}"></div></td>`{{end}}
                  {{if or (eq $layout "full") (eq $layout "receiving")}}rowHtml += `<td><div class="input-group"><input type="text" class="form-control weightin" id="weightin" name="weightin" value="${sortRequest.Weightin}"></div></td>`{{end}}
                  {{if or (eq $layout "full") (eq $layout "receiving")}}rowHtml += `<td><div class="input-group"><input type="text" class="form-control difference" id="difference" name="difference" value="${sortRequest.Difference}" readonly></div></td>`{{end}}
                  {{if or (eq $layout "full") (eq $layout "receiving")}}rowHtml += `<td><div class="input-group"><input type="text" class="form-control differencepercent" id="differencepercent" name="differencepercent" value="${sortRequest.DifferencePercent}" readonly percent></div></td>`{{end}}
                  {{if or (eq $layout "full") (eq $layout "receiving") (eq $layout "mgmt")}}rowHtml += `<td><div class="input-group"><input type="text" class="form-control pieces" id="pieces" name="pieces" pattern="[0-9]+(\.[0-9]+)?" title="Please enter a valid decimal number" value="${sortRequest.Pieces}"></div></td>`{{end}}
                  {{if or (eq $layout "full") (eq $layout "receiving") (eq $layout "mgmt")}}rowHtml += `<td><input type="text" class="form-control hours" id="hours" name="hours" value="${sortRequest.Hours}"></td>`{{end}}
                  {{if or (eq $layout "full") (eq $layout "mgmt")}}rowHtml += `<td><input type="date" class="form-control checkout" id="checkout" name="checkout" value="${sortRequest.Checkout}"></td>`{{end}}
                  {{if or (eq $layout "full") (eq $layout "mgmt")}}rowHtml += `<td><input type="date" class="form-control checkin" id="checkin" name="checkin" value="${sortRequest.Checkin}"></td>`{{end}}
                  {{if or (eq $layout "full") (eq $layout "mgmt")}}
                  rowHtml += `<td>
                    <select class="form-select" id="sorter" name="sorter">
                            ${userOptions}
                    </select>
                  </td>`
                  {{end}}
                  {{if or (eq $layout "full")}}
                  rowHtml += `<td>`
                    {{if $admin}}
                    rowHtml += `<select class="form-select" id="status" name="status">
                      <option value="New" selected>New</option>
                      <option value="Checkout">Checkout</option>
                      <option value="Checkin">Checkin</option>
                    </select>`
                    {{else}}
                      `<input class="form-control" type="text" id="status" name="status" value="" readonly>`
                      {{end}}
                  rowHtml += `</td>`
                  {{end}}
                  {{if or (eq $layout "full") (eq $layout "dataentry")}}
                  rowHtml += `<td>
                    <select class="form-select" id="prty" name="prty">
                      <option value="0">Normal</option>
                      <option value="1">High</option>
                    </select>
                  </td>`
                  {{end}}
                  {{if or (eq $layout "full") (eq $layout "receiving") (eq $layout "dataentry") (eq $layout "mgmt")}}rowHtml += `<td class="btn-col"><input type='hidden' id='active' name='active' value='1'><input type='submit' value='Update' class="btn btn-primary update-request"></td>`{{end}}
                {{if or (eq $layout "full") ($mgmt)}}rowHtml += `<td class="btn-col"><button type="button" class="btn btn-danger archive-request" id="archiveRequest" name="archiveRequest" data-requestid="">Archive</button></td>`{{end}}
                {{if or (eq $layout "full") (eq $layout "receiving") (eq $layout "mgmt")}}rowHtml += `<td class="btn-col"><button class="btn btn-warning error" id="error" name="error" data-requestid="">Error</button></td>`{{end}}
                rowHtml += `</tr>`;
        return rowHtml;
    }
</script>
{{end}}

{{define "updateUserTable"}}
<script>
    function generateTableRow(user, index) {
        // Constructing the row HTML
        var rowHtml = `
        <tr>
            <td data-username="${user.Username}"><input class="form-control" type="text" value="${user.Username}" readonly></td>
            <td data-username="${user.Usercode}"><input class="form-control" type="text" value="${user.Usercode}" readonly></td>
            <td data-username="${user.Role}"><input class="form-control" type="text" value="${user.Role}" readonly></td>
            <td data-username="${user.Manager}">
                <select class="form-select">
                    <option value="${user.Manager}" selected>${user.Manager}</option>
                    <option value="johale">johale</option>
                    <option value="adicke">adicke</option>
                    <option value="cmcclu">cmcclu</option>
                </select>
            </td>
            <td data-username="${user.Sorting}"><input class="form-check-input" type="checkbox" ${user.Sorting ? 'checked' : ''}></td>
            <td><button class="btn btn-primary update-button" data-user-id="${user.Usercode}">Update</button></td>
            <td><button class="btn btn-danger delete-button" data-item-id="${user.Usercode}" data-bs-toggle="modal">Archive</button></td>
        </tr>
        `;

        // Returning the row HTML
        return rowHtml;
    }
</script>
<script>
    function updateUserTable(users, currentPage, totalPages) {
        var tableBody = $('#contentTableBody');
        tableBody.empty(); // Clear existing data

        users.forEach(function(user, index) {
            var row = generateTableRow(user, index);
            tableBody.append(row);
        });

        // Update pagination display, etc.
        updatePaginationControls(currentPage, totalPages);

        console.log("User table updated successfully.");
    }

    function fetchAndUpdateTable(page = 1, limit = 10, searchParams = {}) {
        console.log("Fetching data from /api/users with page " + page + " and limit " + limit);

        // Constructing the search query string from `searchParams` object
        let queryString = $.param({...searchParams, page: page, limit: limit});

        $.ajax({
            url: `/api-handler?targetAPI=/api/users&${queryString}`,
            type: 'GET',
            dataType: 'json',
            success: function(response) {
                console.log("Received data:", response); // Debug the data received
                console.log("Data fetched successfully. Number of records:", response.users.length, "Page:", response.currentPage, "of", response.totalPages);
                updateUserTable(response.users, response.currentPage, response.totalPages);
            },
            error: function(jqXHR, textStatus, errorThrown) {
                console.error("Error during the request:", textStatus, errorThrown, jqXHR);
                let errorMessage = "Error during the request.";
                
                // Try to parse and use the custom error message from the server if available
                if (jqXHR.responseText) {
                    try {
                        let resp = JSON.parse(jqXHR.responseText);
                        if (resp && resp.error) {
                            errorMessage = resp.error;
                        }
                    } catch (e) {
                        console.error("Error parsing server response:", e);
                    }
                }
                showToast(errorMessage, "error");  // Show the custom error message
            },
            beforeSend: function() {
                console.log("Preparing to send AJAX request to /api/users.");
                // Optionally, you can add a loading spinner here
            },
            complete: function(jqXHR, textStatus) {
                console.log("AJAX request completed with status:", textStatus);
                // Optionally, remove the loading spinner here
            }
        });
    }

</script>
{{end}}

{{define "updateCustomerTable"}}
<script>
    function fetchAndUpdateTable(page, limit, searchParams) {
    var queryParams = $.param(searchParams); // Convert search parameters to query string
    var apiUrl = `/api-handler?targetAPI=/api/customers&page=${page}&limit=${limit}&${queryParams}`;
    console.log("Fetching data with search parameters:", searchParams);

    console.log("Fetching data from " + apiUrl);

    $.ajax({
        url: apiUrl,
        type: 'GET',
        dataType: 'json',
        success: function(response) {
            console.log("Data fetched successfully. Number of records:", response.customers.length);
            console.log("Response:", response);
            totalPages = response.totalPages; // set the total pages from the response
            currentPage = response.currentPage; // set the current page from the response
            // Update the customer table with the new data
            updateTable(response.customers);
            $('#loadingSpinner').hide(); // Hide the spinner
            updatePaginationControls();
            console.log("Customer table updated successfully.");
        },
        error: function(jqXHR, textStatus, errorThrown) {
            console.error("Error fetching data:", textStatus, errorThrown, jqXHR);

            // Initialize errorMessage with a default error message
            let errorMessage = "An error occurred. Please try again.";

            // Try to parse and use the custom error message from the server if available
            if (jqXHR.responseText) {
                try {
                    var resp = JSON.parse(jqXHR.responseText);
                    if (resp && resp.error) {
                        errorMessage = resp.error;
                    }
                } catch (e) {
                    console.error("Error parsing server response:", e);
                }
            }
            
            showToast(errorMessage, "error");  // Show the custom error message or the default one
        },

        beforeSend: function() {
            console.log("Preparing to send AJAX request to /api/customers.");
            $('#loadingSpinner').show(); // Show the spinner before sending the request
            // You can add a loading spinner here
        },
        complete: function(jqXHR, textStatus) {
            console.log("AJAX request completed with status:", textStatus);
            // You can remove the loading spinner here
        }
    });
}

    function updateTable(customers) {
        var tableBody = $('#contentTableBody');
        tableBody.empty(); // Clear existing data

        // Add the insert row at the beginning
        var insertRow = GenerateTopRow();
        tableBody.append(insertRow);

        // Loop through the rows
        customers.forEach(function(customer) {
            var row = generateTableRow(customer);
            tableBody.append(row);
        });
    }

    function generateTableRow(customer, index) {
        // Constructing the row HTML
        var rowHtml = `
        <tr>
            <td><input class="form-control" type="text" id="customer_email" value="${customer.customer_email}" readonly></td>
            <td><input class="form-control" type="text" id="first_name" value="${customer.first_name.String}" readonly></td>
            <td><input class="form-control" type="text" id="last_name" value="${customer.last_name.String}" readonly></td>
            <td><input class="form-control" type="text" id="country" value="${customer.country.String}" readonly></td>
            <td><input class="form-control" type="text" id="rebill_day" value="${customer.rebill_day.Int32}" readonly></td>
            <td><input class="form-control" type="text" id="rebill_months" value="${customer.rebill_months.Int32}" readonly></td>
            <td><input class="form-control" type="text" id="autorenew" value="${customer.autorenew}" readonly></td>
            <td><input class="form-control" type="text" id="cratejoy_status" value="${customer.cratejoy_status.String}" readonly></td>
            <td><input class="form-control" type="text" id="start_date" value="${customer.start_date.String.substring(0, 10)}" readonly></td>
            <td><input class="form-control" type="text" id="end_date" value="${customer.end_date.String.substring(0, 10)}" readonly></td>
            <td><input class="form-control" type="text" id="mailchimp_status" value="${customer.mailchimp_status.String}" readonly></td>
            <td><button class="btn btn-primary update-button" data-customer-email="${customer.customer_email}">Update</button></td>
            <td><button class="btn btn-danger delete-button" data-customer-email="${customer.customer_email}" data-bs-toggle="modal" data-bs-target="#ModalDelete${index}">Delete</button></td>
        </tr>
        `;

        // Returning the row HTML
        return rowHtml;
    }
</script>
{{end}}

{{define "sortTable"}}
<script>
    $(document).ready(function() {
        // Attach click event listener to all th elements with data-column attribute
        $('#userTable thead th[data-column]').on('click', function() {
            var column = $(this).index(); // Index of the th within its row
            var type = $(this).data('type');
            sortTable(column, type);
        });

        function sortTable(column, type) {
            console.log(`Sorting by column index ${column} as a ${type}`); // Debugging line

            var rows, switching, i, x, y, shouldSwitch;
            rows = $("#userTableBody tr");
            switching = true;
            
            // Loop until no switching has been done
            while (switching) {
                switching = false;
                
                // Loop through all table rows
                for (i = 0; i < (rows.length - 1); i++) {
                    shouldSwitch = false;

                    // Get the two elements you want to compare
                    x = rows[i].getElementsByTagName("TD")[column];
                    y = rows[i + 1].getElementsByTagName("TD")[column];

                    // Check if the two rows should switch place
                    if (type === "number") {
                        if (Number(x.innerHTML) > Number(y.innerHTML)) {
                            shouldSwitch = true;
                            break;
                        }
                    } else if (type === "string") {
                        if (x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase()) {
                            shouldSwitch = true;
                            break;
                        }
                    } else if (type === "boolean") {
                        var xChecked = x.getElementsByTagName("input")[0].checked;
                        var yChecked = y.getElementsByTagName("input")[0].checked;
                        if (!xChecked && yChecked) {
                            shouldSwitch = true;
                            break;
                        }
                    }
                }
                if (shouldSwitch) {
                    // If a switch has been marked, make the switch and mark that a switch has been done
                    rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
                    switching = true;
                }
            }
        }
    });
</script>
{{end}}

{{define "modalDelete"}}
<!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteModalLabel"></h5>
                    <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <span id="deleteModalText"></span><span id="deleteItemID"></span>?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDelete">Delete</button>
                </div>
            </div>
        </div>
    </div>
{{end}}

{{define "modalImage"}}
<!-- Image Modal -->
    <div class="modal fade" id="imageModal" tabindex="-1" role="dialog" aria-labelledby="imageModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="imageModalLabel">Image Title</h5>
                    <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <img class="w-100" id="modalImage" src="">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
{{end}}

{{define "pageControls"}}
<div class="container">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div class="d-flex justify-content-between align-items-center my-3">
                <nav aria-label="Page navigation" class="d-flex justify-content-center">
                    <ul class="pagination">
                        <li class="page-item" id="prevPage">
                            <a class="page-link" href="#" aria-label="Previous">
                                <span aria-hidden="true">&laquo;</span>
                                <span class="sr-only">Previous</span>
                            </a>
                        </li>
                        <!-- Page number items will be inserted here dynamically -->
                        <li class="page-item" id="nextPage">
                            <a class="page-link" href="#" aria-label="Next">
                                <span aria-hidden="true">&raquo;</span>
                                <span class="sr-only">Next</span>
                            </a>
                        </li>
                    </ul>
                </nav>

                <div class="d-flex align-items-center">
                    <label for="limitSelect" class="me-2" style="min-width: 150px;">Items per page:</label>
                    <select id="limitSelect" class="form-select" style="width: auto;">
                        <option value="10">10</option>
                        <option value="25">25</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                        <option value="250">250</option>
                        <option value="500">500</option>
                    </select>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Update pagination controls
    function updatePaginationControls() {
        console.log("Updating Paginiation Controls")
        
        // Disable prev button if on first page
        if (currentPage <= 1) {
            $('#prevPage').addClass('disabled');
        } else {
            $('#prevPage').removeClass('disabled');
        }

        // Disable next button if on last page
        if (currentPage >= totalPages) {
            $('#nextPage').addClass('disabled');
        } else {
            $('#nextPage').removeClass('disabled');
        }
    }

    // Event listener for the previous page button
    $('#prevPage').click(function(event) {
        event.preventDefault();
        if (currentPage > 1) {
            currentPage--;
            fetchAndUpdateTable(currentPage,limit, {cratejoy_status: "active"});
        }
    });

    // Event listener for the next page button
    $('#nextPage').click(function(event) {
        console.log("next page clicked")
        event.preventDefault();
        if (currentPage < totalPages) {
            currentPage++;
            fetchAndUpdateTable(currentPage,limit, {cratejoy_status: "active"});
        }
    });
    // Refresh the table when the limit changes
    $('#limitSelect').change(function() {
        var limit = $('#limitSelect').val();
        fetchAndUpdateTable(1, limit, {}); // Reset to page 1
    });
</script>
{{end}}

<!-- Dennis Nedry Easter Egg -->
{{define "nedry"}}
<img id="gif" src="https://media.tenor.com/ttEnKdyDKKIAAAAC/jurassic-park-nedry-dennis.gif" style="display:none; position:fixed; top:50%; left:50%; transform: translate(-50%, -50%); z-index: 9999;">
<script>
//Dennis Nedry easter egg
document.addEventListener("keydown", function(event) {
    if (event.ctrlKey && event.key === "m") {
    event.preventDefault(); // prevent browser default action
    var gif = document.getElementById("gif");
    if (gif.style.display === "block") {
        gif.style.display = "none";
    } else {
        gif.style.display = "block";
    }
    }
});
</script>
{{end}}

<!-- Loading Spinner -->
{{define "spinner"}}
<div id="loadingSpinner" class="loading-spinner-overlay">
    <div class="d-flex justify-content-center align-items-center h-100">
        <div class="spinner-border text-primary" role="status">
            <span class="sr-only">Loading...</span>
        </div>
    </div>
</div>
{{end}}