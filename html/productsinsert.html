<html>
<head>
{{template "header"}}
</head>
<body>
  {{template "navigation" .}}
  {{$permission := .Permission.Role}}
  <br> 
  <!-- Message Box -->
  <div aria-live="polite" aria-atomic="true" class="position-relative">
    <div id="toastContainer" class="toast-container position-absolute top-0 end-0 p-3">
        <!-- Toasts will be added here dynamically -->
      </div>
  </div>
  <!-- Image Modal -->
        <div class="modal fade" id="imageModal" tabindex="-1" role="dialog" aria-labelledby="imageModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="imageModalLabel">Image Title</h5>
                        <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <img class="w-100" id="modalImage" src="">
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- Delete Confirmation Modal -->
        <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
          <div class="modal-dialog">
              <div class="modal-content">
                  <div class="modal-header">
                      <h5 class="modal-title" id="deleteModalLabel">Confirm Delete</h5>
                      <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                          <span aria-hidden="true">&times;</span>
                      </button>
                  </div>
                  <div class="modal-body">
                      Are you sure you want to delete the item with SKU: <span id="deleteItemSku"></span>?
                  </div>
                  <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                      <button type="button" class="btn btn-danger" id="confirmDelete">Delete</button>
                  </div>
              </div>
          </div>
      </div>      
        <!-- Main Table -->
        <table class="table table-striped table-hover">
            <thead class="table-dark" style="position: sticky; top: 0; z-index: 1;">
                <tr>
                    <th></th>
                    <th scope="col">SKU</th>
                    <th scope="col">Manufacturer Part #</th>
                    <th scope="col">Product Option</th>
                    {{if eq $permission "admin"}}<th scope="col">Manufacturer</th>{{end}}
                    {{if eq $permission "admin"}}<th scope="col">Processing Request</th>{{end}}
                    <th scope="col">Unit</th>
                    {{if eq $permission "admin"}}<th scope="col">Unit Price</th>{{end}}
                    {{if eq $permission "admin"}}<th scope="col">Currency</th>{{end}}
                    {{if eq $permission "admin"}}<th scope="col">Order Qty</th>{{end}}
                    {{if eq $permission "admin"}}<th scope="col">Reorder</th>{{end}}
                    <th scope="col">Season</th>
                    <th scope="col">Inventory</th>
                    <th></th>
                    <th></th>
                </tr>
            </thead>
            <tbody id="productTableBody">
            </tbody>
        </table>

        <script>
          $(document).ready(function() {
              console.log("Document ready. Initializing table data fetch.");
              f()


              // Fetch manufacturers
              async function f() {
                    try {
                        let manufacturers = await fetchManufacturers();
                        // Call the function to update the table when the page loads
                        fetchAndUpdateTable(manufacturers);
                    } catch (error) {
                        console.error("Error while fetching manufacturers:", error);
                        // Handle error scenario
                    }
                }
      
              // Function to fetch and update table data
              function fetchAndUpdateTable(manufacturers) {
                  console.log("Fetching data from /api/products.");
      
                  $.ajax({
                      url: '/api-handler?targetAPI=/api/products?limit=10',
                      type: 'GET',
                      dataType: 'json',
                      success: function(data) {
                          console.log("Data fetched successfully. Number of records:", data.length);
      
                          var tableBody = $('#productTableBody');
                          tableBody.empty(); // Clear existing data

                          // Currency dropdown options
                          var currencies = ["USD", "CZK", "EUR", "GBP"];
                              
                          // Season dropdown options
                          var seasons = ['None', 'Christmas', 'Fall', 'Halloween'];                              

                          // Add the insert row at the beginning
                          var insertRow = generateInsertRow(manufacturers, currencies, seasons);
                          tableBody.append(insertRow);
      
                          data.forEach(function(item, index) {
                              var row = generateTableRow(item, index, manufacturers, currencies, seasons);
                              tableBody.append(row);
                          });
      
                          console.log("Table updated successfully.");
                      },
                      error: function(jqXHR, textStatus, errorThrown) {
                          console.error("Error fetching data:", textStatus, errorThrown, jqXHR);
                      },
                      beforeSend: function() {
                          console.log("Preparing to send AJAX request to /api/products.");
                      },
                      complete: function(jqXHR, textStatus) {
                          console.log("AJAX request completed with status:", textStatus);
                      }
                  });
              }

              // Event handler for image clicks
              $(document).on('click', '.image-link', function() {
                  var standardUrl = $(this).data('standard-url');
                  var sku = $(this).data('sku');

                  $('#imageModalLabel').text(sku);
                  $('#modalImage').attr('src', standardUrl);
                  $('#imageModal').modal('show');
              });

              var currentItemToDelete; // Global variable to store the current item to delete

              // Event handler for delete button clicks
              $(document).on('click', '.delete-button', function() {
                  var itemId = $(this).data('item-id');
                  currentItemToDelete = itemId;

                  // Show the delete modal
                  var deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
                  $('#deleteItemSku').text(itemId);
                  deleteModal.show();
              });

              // Event handler for the confirm delete action
              $('#confirmDelete').click(function() {
                    console.log("Initiating delete request for item:", currentItemToDelete);

                    $.ajax({
                        url: '/api-handler?targetAPI=/api/productdelete',
                        type: 'POST',
                        contentType: 'application/json',  // Ensure JSON content type
                        dataType: 'json',
                        data: JSON.stringify({ sku: currentItemToDelete }), // Convert data to JSON string
                        success: function(response) {
                            console.log("Item deleted successfully:", response);
                            showToast("SKU deleted successfully.", "info");
                            fetchAndUpdateTable();  // Refresh the table data
                        },
                        error: function(jqXHR, textStatus, errorThrown) {
                            console.error("Error deleting item:", textStatus, errorThrown, jqXHR);
                            showToast("Error deleting item.", "error");
                        },
                        beforeSend: function() {
                            console.log("Sending delete request to /api/productdelete.");
                        },
                        complete: function(jqXHR, textStatus) {
                            console.log("Delete request completed with status:", textStatus);
                            $('#deleteModal').modal('hide'); // Hide the modal after completion
                        }
                    });
                });

            
          });
      </script>
      {{template "toast" .}}
      {{template "fetchmanufacturers" .}}
      {{template "insertProductRow" .}}
      {{template "tableProductRow" .}}
      {{template "insertProductButton" .}}
      {{template "updateProductButton" .}}
      
  {{template "footer" .}}
</body>
</html>