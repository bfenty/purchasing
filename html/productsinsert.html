<html>
<head>
{{template "header"}}
<script>
$(document).ready(function(){
  $(document).on('click', '#btnInsert', function(){ 
      const Http = new XMLHttpRequest();
      const url='/productexist?sku='+document.getElementById('insertform').elements[0].value;
      Http.open("GET", url);
      Http.send();
      Http.onreadystatechange=(e)=>{
      if (Http.responseText=="FALSE") {
        document.getElementById("insertform").submit(); 
      } else if (Http.responseText=="TRUE") {
        $('#ModalInsert').modal('toggle');
      }
      }
  });
  $(document).on('click', '#btnOverwrite', function(){
        document.getElementById("insertform").submit(); 
  });
});
</script>
</head>
<body>
  {{template "navigation" .}}
  <br> 
  <!-- Message Box -->
  <div aria-live="polite" aria-atomic="true" class="position-relative">
    <div id="toastContainer" class="toast-container position-absolute top-0 end-0 p-3">
        <!-- Toasts will be added here dynamically -->
      </div>
  </div>
  <!-- Image Modal -->
        <div class="modal fade" id="imageModal" tabindex="-1" role="dialog" aria-labelledby="imageModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="imageModalLabel">Image Title</h5>
                        <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <img class="w-100" id="modalImage" src="">
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- Delete Confirmation Modal -->
        <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
          <div class="modal-dialog">
              <div class="modal-content">
                  <div class="modal-header">
                      <h5 class="modal-title" id="deleteModalLabel">Confirm Delete</h5>
                      <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                          <span aria-hidden="true">&times;</span>
                      </button>
                  </div>
                  <div class="modal-body">
                      Are you sure you want to delete the item with SKU: <span id="deleteItemSku"></span>?
                  </div>
                  <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                      <button type="button" class="btn btn-danger" id="confirmDelete">Delete</button>
                  </div>
              </div>
          </div>
      </div>      
        <!-- Main Table -->
        <table class="table table-striped table-hover">
            <thead class="table-dark" style="position: sticky; top: 0; z-index: 1;">
                <tr>
                    <th></th>
                    <th scope="col">SKU</th>
                    <th scope="col">Manufacturer Part #</th>
                    <th scope="col">Product Option</th>
                    <th scope="col">Manufacturer</th>
                    <th scope="col">Processing Request</th>
                    <th scope="col">Unit</th>
                    <th scope="col">Unit Price</th>
                    <th scope="col">Currency</th>
                    <th scope="col">Order Qty</th>
                    <th scope="col">Reorder</th>
                    <th scope="col">Season</th>
                    <th scope="col">Inventory</th>
                    <th></th>
                    <th></th>
                </tr>
            </thead>
            <tbody id="productTableBody">
            </tbody>
        </table>

        <script>
          $(document).ready(function() {
              console.log("Document ready. Initializing table data fetch.");

              //Show messages to the user
              function showToast(message, type) {
              var toastTypeClass = '';
              switch (type) {
                  case 'error': toastTypeClass = 'bg-danger'; break;
                  case 'warning': toastTypeClass = 'bg-warning text-dark'; break;
                  case 'info': toastTypeClass = 'bg-success'; break;
                  default: toastTypeClass = 'bg-secondary';
              }

              var toastId = 'toast' + Date.now(); // Unique ID for each toast
              var toastHtml = `
                  <div class="toast ${toastTypeClass}" id="${toastId}" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="5000">
                      <div class="toast-body">
                          ${message}
                      </div>
                  </div>`;

              $('#toastContainer').append(toastHtml);
              var toast = new bootstrap.Toast($('#' + toastId));
              toast.show();
              }

              // Fetch manufacturers
              var manufacturers = [];
              $.ajax({
                  url: '/api/manufacturers',
                  type: 'GET',
                  dataType: 'json',
                  success: function(data) {
                      console.log("Manufacturers fetched successfully. Data:", data);
                      manufacturers = data;
                      // After manufacturers are loaded, fetch and display the products
                      fetchAndUpdateTable();
                  },
                  error: function(jqXHR, textStatus, errorThrown) {
                      console.error("Error fetching manufacturers:", textStatus, errorThrown, jqXHR);
                      showToast("Error fetching manufacturers.", "error");
                  },
                  beforeSend: function() {
                      console.log("Sending request to fetch manufacturers.");
                  },
                  complete: function(jqXHR, textStatus) {
                      console.log("Request to fetch manufacturers completed with status:", textStatus);
                  }
              });
      
              // Function to fetch and update table data
              function fetchAndUpdateTable() {
                  console.log("Fetching data from /api/products.");
      
                  $.ajax({
                      url: '/api/products',
                      type: 'GET',
                      dataType: 'json',
                      success: function(data) {
                          console.log("Data fetched successfully. Number of records:", data.length);
      
                          var tableBody = $('#productTableBody');
                          tableBody.empty(); // Clear existing data

                          // Manufacturer dropdown options
                          var manufacturerOptions = '<option value="" selected>Select Manufacturer</option>';
                          manufacturers.forEach(function(manufacturer) {
                              manufacturerOptions += `<option value="${manufacturer.name}">${manufacturer.name}</option>`;
                          });

                          // Currency dropdown options
                          var currencies = ["USD", "CZK", "EUR", "GBP"];
                          var currencyOptions = '<option value="" selected>Select Currency</option>';
                          currencies.forEach(function(currency) {
                              currencyOptions += `<option value="${currency}">${currency}</option>`;
                          });

                          // Add the insert row at the beginning
                          var insertRow = `<tr class="table-info">
                                              <td></td>
                                              <td><input class="form-control" type='text' id="new_sku"></td>
                                              <td><input class="form-control" type='text' id="new_manufacturerpart"></td>
                                              <td><input class="form-control" type='text' id="new_description"></td>
                                              <td><select class="form-select" id="new_manufacturer">${manufacturerOptions}</select></td>
                                              <td><input class="form-control" type='text' id="new_processrequest"></td>
                                              <td><input class="form-control" type='text' id="new_unit"></td>
                                              <td><input class="form-control" type='text' id="new_unitprice"></td>
                                              <td><select class="form-select" id="new_currency">${currencyOptions}</select></td>
                                              <td><input class="form-control" type='text' id="new_orderqty"></td>
                                              <td><input class="form-check-input" type='checkbox' id="reorder" name="reorder" checked></td>
                                              <td><input class="form-control" type='text' id="new_season"></td>
                                              <td><input class="form-control" type='text' id="new_inventoryqty"></td>
                                              <td><button class="btn btn-primary" id="btnInsertNew">Insert</button></td>
                                              <td></td>
                                          </tr>`;
                          tableBody.append(insertRow);
      
                          data.forEach(function(item, index) {
                              console.log("Processing item:", index, item);
                              //create a map of acceptable currencies and select the correct one
                              var currencies = ["USD", "CZK", "EUR", "GBP"];
                              var currencyOptions = currencies.map(function(currency) {
                                  return `<option value="${currency}" ${currency === item.Currency ? 'selected' : ''}>${currency}</option>`;
                              }).join('');

                              //Create a map of all manufacturers
                              var manufacturerOptions = manufacturers.map(function(manufacturer) {
                                  return `<option value="${manufacturer.name}" ${manufacturer.name === item.Manufacturer ? 'selected' : ''}>${manufacturer.name}</option>`;
                              }).join('');


                              var row = `<tr>
                                            <td><a role="button" class="image-link" data-standard-url="${item.Image.url_standard}" data-sku="${item.SKU}"><img class="img-rounded" data-bs-toggle="modal" data-bs-target="#ModalImage0" src="${item.Image.url_tiny}" height="45px"></a></td>
                                            <td><input class="form-control" type='text' id="sku" name="sku" value="${item.SKU}"></td>
                                            <td><input class="form-control" type='text' id="manufacturerpart" name="manufacturerpart" value="${item.ManufacturerPart}"></td>
                                            <td><input class="form-control" type='text' id="description" name="description" value="${item.Description}"></td>
                                            <td><select class="form-select" id="manufacturer" name="manufacturer">${manufacturerOptions}</select></td>
                                            <td><input class="form-control" type='text' id="processrequest" name="processrequest" value="${item.ProcessRequest}"></td>
                                            <td><input class="form-control" type='text' id="unit" name="unit" value="${item.Unit}"></td>
                                            <td><input class="form-control" type='text' id="unitprice" name="unitprice" value="${item.UnitPrice}"></td>
                                            <td><select class="form-select" id="currency" name="currency">${currencyOptions}</select></td>
                                            <td><input class="form-control" type='text' id="orderqty" name="orderqty" value="${item.OrderQty}"></td>
                                            <td><input class="form-check-input" type='checkbox' id="reorder" name="reorder" ${item.Reorder ? 'checked' : ''}></td>
                                            <td><input class="form-control" type='text' id="season" name="season" value="${item.Season}"></td>
                                            <td><input class="form-control" type='text' id="inventoryqty" name="inventoryqty" value="${item.InventoryQty}"></td>
                                            <td><input type='button' value='Update' class='btn btn-primary update-button' data-item-id='${item.SKU}'></td>
                                            <td><button type="button" class="btn btn-danger delete-button" data-item-id="${item.SKU}" data-bs-toggle="modal">Delete</button></td>
                                         </tr>`;
                              tableBody.append(row);
                          });
      
                          console.log("Table updated successfully.");
                      },
                      error: function(jqXHR, textStatus, errorThrown) {
                          console.error("Error fetching data:", textStatus, errorThrown, jqXHR);
                      },
                      beforeSend: function() {
                          console.log("Preparing to send AJAX request to /api/products.");
                      },
                      complete: function(jqXHR, textStatus) {
                          console.log("AJAX request completed with status:", textStatus);
                      }
                  });
              }
      
              // Call the function to update the table when the page loads
              fetchAndUpdateTable();

              // Event handler for image clicks
              $(document).on('click', '.image-link', function() {
                  var standardUrl = $(this).data('standard-url');
                  var sku = $(this).data('sku');

                  $('#imageModalLabel').text(sku);
                  $('#modalImage').attr('src', standardUrl);
                  $('#imageModal').modal('show');
              });

              var currentItemToDelete; // Global variable to store the current item to delete

              // Event handler for delete button clicks
              $(document).on('click', '.delete-button', function() {
                  var itemId = $(this).data('item-id');
                  currentItemToDelete = itemId;

                  // Show the delete modal
                  var deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
                  $('#deleteItemSku').text(itemId);
                  deleteModal.show();
              });

              // Event handler for the confirm delete action
              $('#confirmDelete').click(function() {
                    console.log("Initiating delete request for item:", currentItemToDelete);

                    $.ajax({
                        url: '/api/productdelete',
                        type: 'POST',
                        contentType: 'application/json',  // Ensure JSON content type
                        dataType: 'json',
                        data: JSON.stringify({ sku: currentItemToDelete }), // Convert data to JSON string
                        success: function(response) {
                            console.log("Item deleted successfully:", response);
                            showToast("SKU deleted successfully.", "info");
                            fetchAndUpdateTable();  // Refresh the table data
                        },
                        error: function(jqXHR, textStatus, errorThrown) {
                            console.error("Error deleting item:", textStatus, errorThrown, jqXHR);
                            showToast("Error deleting item.", "error");
                        },
                        beforeSend: function() {
                            console.log("Sending delete request to /api/productdelete.");
                        },
                        complete: function(jqXHR, textStatus) {
                            console.log("Delete request completed with status:", textStatus);
                            $('#deleteModal').modal('hide'); // Hide the modal after completion
                        }
                    });
                });

              $('#productTableBody').on('click', '#btnInsertNew', function() {
                  console.log("Collecting data to insert new Product");
                  var validationMessage = validateNewProductForm();
                    if (validationMessage !== "") {
                        showToast(validationMessage, "warning");
                        return;
                    }
                  // Collecting input data
                  var newProductData = {
                        sku: $('#new_sku').val(),
                        manufacturerPart: $('#new_manufacturerpart').val() || null,
                        description: $('#new_description').val() || null,
                        manufacturer: $('#new_manufacturer').val() || null,
                        processRequest: $('#new_processrequest').val() || null,
                        unit: $('#new_unit').val() || null,
                        currency: $('#currency').val() || null,
                        unitPrice: $('#new_unitprice').val() ? parseFloat($('#new_unitprice').val()) : null,
                        orderQty: $('#new_orderqty').val() ? parseInt($('#new_orderqty').val(), 10) : null,
                        reorder: $('#new_reorder').is(':checked'),
                        season: $('#new_season').val() || null,
                        inventoryQty: $('#new_inventoryqty').val() ? parseInt($('#new_inventoryqty').val(), 10) : null
                    };

                  console.log("Preparing to insert new product:", newProductData);

                  // AJAX call to insert the new product
                  $.ajax({
                      url: '/api/productinsert', // API endpoint for product insertion
                      type: 'POST',
                      contentType: 'application/json',
                      data: JSON.stringify(newProductData),
                      success: function(response) {
                          console.log("New product inserted successfully:", response);
                            showToast("SKU inserted successfully.", "info");
                          fetchAndUpdateTable() //update the table
                      },
                      error: function(jqXHR, textStatus, errorThrown) {
                            console.error("Error inserting new product:", textStatus, errorThrown, jqXHR);
                            if(jqXHR.responseText) {
                                try {
                                    var resp = JSON.parse(jqXHR.responseText);
                                    showToast(resp.error, "error");
                                } catch(e) {
                                    showToast("Error inserting new product.", "error");
                                }
                            } else {
                                showToast("Error inserting new product.", "error");
                            }
                        },
                        beforeSend: function() {
                            console.log("Sending request to insert new product.");
                        },
                        complete: function(jqXHR, textStatus) {
                            console.log("Request to insert new product completed with status:", textStatus);
                        }
                  });
              });

              //Validate product insertion before submission
              function validateNewProductForm() {
                var missingFields = [];

                // Check SKU - required
                if ($('#new_sku').val().trim() === '') {
                    missingFields.push("SKU");
                }

                // Check Manufacturer Part - assuming it's required
                if ($('#new_manufacturerpart').val().trim() === '') {
                    missingFields.push("Manufacturer Part");
                }

                // Check Manufacturer - assuming it's required
                if ($('#new_manufacturer').val().trim() === '') {
                    missingFields.push("Manufacturer");
                }

                // Check Currency - assuming it's required
                if ($('#currency').val().trim() === '') {
                    missingFields.push("Currency");
                }

                // Check Unit - assuming it's required
                if ($('#new_unit').val().trim() === '') {
                    missingFields.push("Unit");
                }

                // Check Unit Price - assuming it's required and must be a valid number
                var unitPrice = $('#new_unitprice').val().trim();
                if (unitPrice === '' || isNaN(parseFloat(unitPrice))) {
                    missingFields.push("Unit Price");
                }

                // Check Order Qty - assuming it's required and must be a valid integer
                var orderQty = $('#new_orderqty').val().trim();
                if (orderQty === '' || !(/^\d+$/.test(orderQty))) {
                    missingFields.push("Order Quantity");
                }

                // Check Inventory Qty - assuming it's required and must be a valid integer
                var inventoryQty = $('#new_inventoryqty').val().trim();
                if (inventoryQty === '' || !(/^\d+$/.test(inventoryQty))) {
                    missingFields.push("Inventory Quantity");
                }

                if (missingFields.length > 0) {
                    return "Please fill in the following required fields: " + missingFields.join(", ");
                }

                return "";
            }
            // Event listener for the update button click
                $('#productTableBody').on('click', '.update-button', function() {
                    var row = $(this).closest('tr');
                    var sku = $(this).data('item-id');

                    var updatedProductData = {
                        SKU: sku,
                        ManufacturerPart: row.find('[name="manufacturerpart"]').val(),
                        Description: row.find('[name="description"]').val(),
                        Manufacturer: row.find('[name="manufacturer"]').val(),
                        ProcessRequest: row.find('[name="processrequest"]').val(),
                        Unit: row.find('[name="unit"]').val(),
                        UnitPrice: parseFloat(row.find('[name="unitprice"]').val()),
                        OrderQty: parseInt(row.find('[name="orderqty"]').val(), 10),
                        Reorder: row.find('[name="reorder"]').is(':checked'),
                        Season: row.find('[name="season"]').val(),
                        InventoryQty: parseInt(row.find('[name="inventoryqty"]').val(), 10),
                        Currency: row.find('[name="currency"]').val()
                    };

                    console.log("Preparing to update product:", updatedProductData);

                    // AJAX call to update the product
                    $.ajax({
                        url: '/api/productupdate',
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify(updatedProductData),
                        success: function(response) {
                            console.log("Product updated successfully:", response);
                            showToast("SKU updated successfully.", "info");
                            fetchAndUpdateTable() //update the table
                        },
                        error: function(jqXHR, textStatus, errorThrown) {
                            console.error("Error updating product:", textStatus, errorThrown, jqXHR);
                            // Handle error
                        }
                    });
                });
          });
      </script>
      
  {{template "footer" .}}
</body>
</html>