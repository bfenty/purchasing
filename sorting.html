<html>
<head>
  {{template "header"}}
  <style>

    #message {
      position: fixed;
      top: 10px;
      right: 10px;
      z-index: 999;
    }
    .table-responsive-stack tr {
      display: -webkit-box;
      display: -ms-flexbox;
      display: flex;
      -webkit-box-orient: horizontal;
      -webkit-box-direction: normal;
          -ms-flex-direction: row;
              flex-direction: row;
    }


    .table-responsive-stack td,
    .table-responsive-stack th {
      display:block;
    /*      
      flex-grow | flex-shrink | flex-basis   */
      -ms-flex: 1 1 auto;
        flex: 1 1 auto;
    }

    .table-responsive-stack .table-responsive-stack-thead {
      font-weight: bold;
    }

    @media screen and (max-width: 768px) {
      .table-responsive-stack tr {
          -webkit-box-orient: vertical;
          -webkit-box-direction: normal;
              -ms-flex-direction: column;
                  flex-direction: column;
          border-bottom: 3px solid #ccc;
          display:block;
          
      }
      /*  IE9 FIX   */
      .table-responsive-stack td {
          float: left\9;
          width:100%;
      }
    }
  </style>
</head>
<body>
  {{template "navigation" .}}
  {{$permission := .Permission.Role}}
  {{$admin := .Permission.Permissions.Admin}}
  <div>
    <div id="message" class="alert"></div>
    <h1>{{.Title}}</h1>
    <div class="row" id="userTable">
      <div class="col-sm-12">
        <div class="table-responsive">
          <table class="table table-striped table-responsive-stack" id="sorttable">
            <thead class="table-dark" style="position: sticky; top: 0; z-index: 1;">
              <tr>
                <th>Request ID</th>
                <th>SKU</th>
                <th>Description</th>
                <th>Manufacturer Part</th>
                <th>Instructions</th>
                <th>Weight Out</th>
                <th>Weight In</th>
                <th>Difference</th>
                <th>Pieces</th>
                <th>Check Out</th>
                <th>Check In</th>
                <th>Sorter</th>
                <th>Status</th>
                <th>Priority</th>
                <th></th>
                <th></th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              {{range $index, $value := .SortRequests}}
              <form id="row{{$index}}">
                <tr>
                  <td><input type="text" class="form-control requestid" id="requestid" name="requestid" value="{{.ID}}"></td>
                  <td><input type="text" class="form-control sku" id="sku" name="sku" value="{{.SKU}}"></td>
                  <td><input type="text" class="form-control description" id="description" name="description" value="{{.Description}}"></td>
                  <td><input type="text" class="form-control manufacturerpart" id="manufacturerpart" name="manufacturerpart" value="{{.ManufacturerPart}}"></td>
                  <td><input type="text" class="form-control instructions" id="instructions" name="instructions" value="{{.Instructions}}"></td>
                  <td><div class="input-group"><input type="text" class="form-control weightout" id="weightout" name="weightout" value="{{.Weightout}}"><span class="input-group-text">g</span></div></td>
                  <td><div class="input-group"><input type="text" class="form-control weightin" id="weightin" name="weightin" value="{{.Weightin}}"><span class="input-group-text">g</span></div></td>
                  <td><div class="input-group"><input type="text" class="form-control difference" id="difference" name="difference" value="{{.Difference}}" readonly><span class="input-group-text">g</span></div></td>
                  <td><div class="input-group"><input type="text" class="form-control pieces" id="pieces" name="pieces" value="{{.Pieces}}"><span class="input-group-text">pcs</span></div></td>
                  <td><input type="date" class="form-control checkout" id="checkout" name="checkout" value="{{.Checkout}}"></td>
                  <td><input type="date" class="form-control checkin" id="checkin" name="checkin" value="{{.Checkin}}"></td>
                  <td>
                    <select class="form-select" id="sorter" name="sorter">
                      <option selected disabled value> {{.Sorter}}</option>
                      {{range $.Users}}
                      <option value='{{.Username}}'>{{.Username}}</option>
                      {{end}}
                      <option></option>
                    </select>
                  </td>
                  <td>
                    {{if $admin}}
                    <select class="form-select" id="status" name="status">
                      <option value="New" {{if eq .Status "New"}}selected{{end}}>New</option>
                      <option value="Checkout" {{if eq .Status "Checkout"}}selected{{end}}>Checkout</option>
                      <option value="Checkin" {{if eq .Status "Checkin"}}selected{{end}}>Checkin</option>
                    </select>
                    {{else}}
                      <input class="form-control" type="text" id="status" name="status" value="{{.Status}}" readonly>
                    {{end}}
                  </td>
                  <td>
                    <select class="form-select" id="prty" name="prty">
                      <option value="0" {{if eq .Priority 0}}selected{{end}}>Normal</option>
                      <option value="1" {{if eq .Priority 1}}selected{{end}}>High</option>
                    </select>
                  </td>
                  <td><input type='hidden' id='active' name='active' value='1'><input type='submit' value='Update' class="btn btn-primary update-request"></td>
                  <td><button type="button" class="btn btn-danger archive-request" id="archiveRequest" name="archiveRequest" data-requestid="{{.ID}}">Archive</button></td>
                  <td></td>
                </tr>
                
              </form>
            {{end}}
            </tbody>
          </table>
          <br>
          <br>
        </div>
      </div>
    </div>
  </div>
  {{template "footer" .}}
  <script>
    document.querySelectorAll('form').forEach(form => {
  form.addEventListener('submit', e => {
    e.preventDefault();

    let formId = e.target.id;
    let form = document.getElementById(formId);
    let data = new FormData(form);

    console.log('Form data:', data);

    fetch('/sortingupdate', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(Object.fromEntries(data))
    })
    .then(response => {
      if (!response.ok) {
        throw new Error('Network response was not ok');
      }
      return response.json();
    })
    .then(data => {
      console.log('Server response:', data);
      // Handle the response from the server
      let messageDiv = document.getElementById('message');
      if (data.Success) {
        messageDiv.style.display = 'block';
        messageDiv.classList.remove('alert-danger');
        messageDiv.classList.add('alert-success');
        messageDiv.innerText = data.Body;
      } else {
        messageDiv.style.display = 'block';
        messageDiv.classList.remove('alert-success');
        messageDiv.classList.add('alert-danger');
        messageDiv.innerText = data.Body;
      }
      // Remove the message after 5 seconds
      setTimeout(() => {
        messageDiv.style.display = 'none';
      }, 5000);
    })
    .catch(error => {
      console.error('Error:', error);
      // Handle the error
    });
  });
});
  </script>
  <script>
    $(document).ready(function() {
      // Handle click event for Archive button
      $('.archive-request').on('click', function() {
        // Get the user code from the data attribute
        var requestid = $(this).data('requestid');
  
        // Store a reference to the clicked button for later use
        var $clickedButton = $(this);
  
        // Show the modal dialogue
        $('#archiveRequestModal').modal('show');
  
        // Handle confirmation
        $('#confirmArchiveRequest').on('click', function() {
          // Make AJAX call to API endpoint
          $.ajax({
            url: '/sortingupdate',
            method: 'POST',
            data: {  
              requestid: requestid,
              active: 0
            },
            success: function(response) {
              // Display success message
              $clickedButton.closest('tr').find('.alert').addClass('alert-success').text('Request archived successfully.');
  
              // Hide the modal dialogue
              $('#archiveRequestModal').modal('hide');
  
              // Reload the page
              location.reload();
            },
            error: function(xhr, status, error) {
              // Display error message
              $clickedButton.closest('tr').find('.alert').addClass('alert-danger').text(xhr.responseText);
  
              // Hide the modal dialogue
              $('#archiveRequestModal').modal('hide');
            }
          });
        });
      });
    });
  </script>
  <script>
    $(document).ready(function() {   
      // inspired by http://jsfiddle.net/arunpjohny/564Lxosz/1/
      $('.table-responsive-stack').each(function (i) {
        var id = $(this).attr('id');
        //alert(id);
        $(this).find("th").each(function(i) {
            $('#'+id + ' td:nth-child(' + (i + 1) + ')').prepend('<span class="table-responsive-stack-thead">'+             $(this).text() + ':</span> ');
            $('.table-responsive-stack-thead').hide();
            
        });
      });

      $( '.table-responsive-stack' ).each(function() {
      var thCount = $(this).find("th").length; 
      var rowGrow = 100 / thCount + '%';
      //console.log(rowGrow);
      $(this).find("th, td").css('flex-basis', rowGrow);   
      });

      function flexTable(){
      if ($(window).width() < 768) {
        
      $(".table-responsive-stack").each(function (i) {
        $(this).find(".table-responsive-stack-thead").show();
        $(this).find('thead').hide();
      });
      
      // window is less than 768px   
      } else {
        
        
      $(".table-responsive-stack").each(function (i) {
        $(this).find(".table-responsive-stack-thead").hide();
        $(this).find('thead').show();
      });

      }
      // flextable   
      }      

      flexTable();

      window.onresize = function(event) {
      flexTable();
      };
      // document ready  
      });
  </script>
    <!-- Modal Dialogue -->
      <div class="modal fade" id="archiveRequestModal" tabindex="-1" role="dialog" aria-labelledby="archiveRequestModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="archiveRequestModalLabel">Confirm Archive Request</h5>
              <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <p>Are you sure you want to archive this request?</p>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="button" class="btn btn-danger" id="confirmArchiveRequest">Archive Request</button>
            </div>
          </div>
        </div>
      </div>
</body>
</html>